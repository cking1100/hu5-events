<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <!-- Preload critical resources -->
    <link rel="preload" href="/site.webmanifest" as="fetch" crossorigin />

    <link rel="manifest" href="/site.webmanifest" />
    <!-- Google tag (gtag.js) -->
    <link
      rel="preconnect"
      href="https://www.googletagmanager.com"
      crossorigin
    />
    <link
      rel="preconnect"
      href="https://www.google-analytics.com"
      crossorigin
    />
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />
    <link rel="dns-prefetch" href="https://www.google-analytics.com" />
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-Q98ES83PZK"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-Q98ES83PZK", {
        anonymize_ip: true,
        send_page_view: false,
      });
    </script>

    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />

    <title>Find HU5 Events â€” Hull gigs, pub nights & open mics</title>
    <meta
      name="description"
      content="Whatâ€™s on in Hullâ€™s HU5: live music, quizzes, comedy nights and open mics at Polar Bear, Adelphi, Welly, The Peopleâ€™s Republic, UMU and more â€” updated daily."
    />
    <meta
      name="robots"
      content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"
    />
    <meta
      name="googlebot"
      content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"
    />
    <meta name="color-scheme" content="dark light" />
    <meta
      name="theme-color"
      content="#050818"
      media="(prefers-color-scheme: dark)"
    />
    <meta
      name="theme-color"
      content="#f0f8ff"
      media="(prefers-color-scheme: light)"
    />
    <meta name="language" content="en-GB" />
    <meta name="author" content="Find HU5 Events" />
    <meta name="creator" content="Find HU5 Events" />
    <link rel="canonical" href="https://www.findhu5.events/" />

    <!-- Icons / PWA -->
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <!-- Social sharing (Open Graph) -->
    <meta
      property="og:title"
      content="Find HU5 Events â€” Hull gigs, pub nights & open mics"
    />
    <meta
      property="og:description"
      content="All HU5 events in one place: gigs, quizzes, comedy, and more â€” updated daily."
    />
    <meta property="og:url" content="https://www.findhu5.events/" />
    <meta property="og:type" content="website" />
    <meta
      property="og:image"
      content="https://www.findhu5.events/og-preview.png"
    />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta
      property="og:image:alt"
      content="Find HU5 Events - Event discovery for Hull"
    />
    <meta property="og:locale" content="en_GB" />
    <meta property="og:site_name" content="Find HU5 Events" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content="Find HU5 Events â€” Hull gigs, pub nights & open mics"
    />
    <meta
      name="twitter:description"
      content="Whatâ€™s on in HU5 tonight and this week."
    />
    <meta
      name="twitter:image"
      content="https://www.findhu5.events/og-preview.png"
    />
    <meta
      name="twitter:image:alt"
      content="Find HU5 Events - Event discovery for Hull"
    />

    <!-- Structured data (helps Google understand the site + site search) -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "Find HU5 Events",
        "url": "https://www.findhu5.events/",
        "description": "Listings for gigs, pub nights and open mics around Hullâ€™s HU5.",
        "potentialAction": {
          "@type": "SearchAction",
          "target": "https://www.findhu5.events/?q={search_term_string}",
          "query-input": "required name=search_term_string"
        }
      }
    </script>

    <style>
      :root {
        --bg: #050818;
        --bg-gradient: linear-gradient(
          135deg,
          #050818 0%,
          #0a1128 50%,
          #0f1f45 100%
        );
        --card: #0d1b35;
        --card-gradient: linear-gradient(135deg, #0d1b35 0%, #091429 100%);
        --text: #e8f2ff;
        --muted: #8fa3c0;
        --accent: #00d4ff;
        --accent2: #00f0ff;
        --accent3: #0088ff;
        --accent4: #0066ff;
        --border: #1a3a7f;
        --chip: #0f2847;
        --pill: #0a1628;
        --good: #00ff88;
        --warn: #ffaa00;
        --error: #ff4466;
        --glow: rgba(0, 212, 255, 0.4);
        --glow-strong: rgba(0, 240, 255, 0.6);
        --radius: 16px;
        --shadow: 0 0 20px rgba(0, 212, 255, 0.25);
        --shadow-lg: 0 0 40px rgba(0, 212, 255, 0.35);
        --tap: 44px;
        --safe: env(safe-area-inset-bottom, 0px);
      }
      @media (prefers-color-scheme: light) {
        :root {
          --bg: #f0f8ff;
          --bg-gradient: linear-gradient(
            135deg,
            #f0f8ff 0%,
            #e0efff 50%,
            #d0e8ff 100%
          );
          --card: #ffffff;
          --card-gradient: linear-gradient(135deg, #ffffff 0%, #f5faff 100%);
          --text: #0a1f4f;
          --muted: #5080c0;
          --accent: #0066ff;
          --accent2: #0088ff;
          --accent3: #0055dd;
          --accent4: #0044cc;
          --border: #b0d4ff;
          --chip: #e8f4ff;
          --pill: #d0ecff;
          --good: #00cc66;
          --warn: #ff8800;
          --error: #ff3344;
          --glow: rgba(0, 102, 255, 0.2);
          --glow-strong: rgba(0, 136, 255, 0.3);
          --shadow: 0 0 20px rgba(0, 102, 255, 0.15);
          --shadow-lg: 0 0 40px rgba(0, 102, 255, 0.25);
        }
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      html {
        scroll-behavior: smooth;
        scroll-padding-top: 160px;
      }
      body {
        margin: 0;
        background: var(--bg-gradient);
        color: var(--text);
        font: clamp(14px, 1.9vw, 16px) / 1.55 system-ui, -apple-system, Segoe UI,
          Roboto, Arial;
        overflow-x: hidden;
        text-rendering: optimizeLegibility;
        position: relative;
      }
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            circle at 20% 50%,
            rgba(0, 212, 255, 0.12) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 80%,
            rgba(0, 240, 255, 0.12) 0%,
            transparent 50%
          );
        pointer-events: none;
        z-index: -1;
      }
      body::after {
        content: "";
        position: fixed;
        top: -50%;
        left: -20%;
        width: 140%;
        height: 200%;
        background: radial-gradient(
          circle at 30% 40%,
          rgba(0, 102, 255, 0.08) 0%,
          transparent 40%
        );
        pointer-events: none;
        z-index: -2;
        animation: drift 15s ease-in-out infinite;
      }
      @keyframes shimmer {
        0% {
          transform: translateX(-100%) translateY(-100%) rotate(45deg);
        }
        100% {
          transform: translateX(100%) translateY(100%) rotate(45deg);
        }
      }
      @keyframes drift {
        0%,
        100% {
          transform: translate(0, 0);
        }
        50% {
          transform: translate(20px, 30px);
        }
      }
      @keyframes glow-pulse {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(0, 212, 255, 0.4),
            inset 0 0 20px rgba(0, 212, 255, 0.1);
        }
        50% {
          box-shadow: 0 0 40px rgba(0, 240, 255, 0.6),
            inset 0 0 30px rgba(0, 212, 255, 0.2);
        }
      }
      @keyframes shine {
        0% {
          background-position: -1000px 0;
        }
        100% {
          background-position: 1000px 0;
        }
      }
      .hidden {
        display: none !important;
      }
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation: none !important;
          transition: none !important;
          scroll-behavior: auto !important;
        }
      }

      /* (all your existing CSS below unchanged) */
      .topbar {
        position: static;
        top: auto;
        z-index: 70;
        background: color-mix(in oklab, var(--bg) 85%, transparent);
        border-bottom: 1px solid var(--border);
        backdrop-filter: saturate(180%) blur(20px);
        -webkit-backdrop-filter: blur(20px);
        box-shadow: 0 4px 20px rgba(0, 212, 255, 0.1);
        width: 100%;
      }
      .wrap {
        max-width: 980px;
        margin: 0 auto;
        padding: 12px;
        width: 100%;
        box-sizing: border-box;
      }
      .topbar .wrap {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        width: 100%;
        box-sizing: border-box;
      }
      .topbar-social {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .lead {
        font-weight: 900;
        font-size: 13px;
        color: var(--muted);
      }
      .topbar a {
        color: var(--accent);
        text-decoration: none;
        font-weight: 800;
        padding: 6px 10px;
        border-radius: 999px;
        background: transparent;
        border: 1px solid var(--accent);
        transition: all 0.3s ease;
      }
      .topbar a:hover {
        background: color-mix(in oklab, var(--accent) 20%, transparent);
        border-color: var(--accent2);
        box-shadow: 0 0 15px var(--glow);
      }
      .topbar a.social-link {
        position: relative;
        overflow: hidden;
        background: linear-gradient(
          135deg,
          #f58529 0%,
          #dd2a7b 50%,
          #8134af 100%
        );
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        padding: 6px 12px;
        font-weight: 700;
        letter-spacing: 0.3px;
      }
      .topbar a.social-link::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          45deg,
          transparent 30%,
          rgba(255, 255, 255, 0.3) 50%,
          transparent 70%
        );
        transform: rotate(45deg);
        animation: shimmer 3s infinite;
        pointer-events: none;
      }
      @keyframes shimmer {
        0% {
          transform: translateX(-100%) translateY(-100%) rotate(45deg);
        }
        100% {
          transform: translateX(100%) translateY(100%) rotate(45deg);
        }
      }
      .topbar a.social-link:hover {
        border-color: #fff;
        box-shadow: 0 0 20px rgba(245, 133, 41, 0.5),
          inset 0 0 20px rgba(255, 255, 255, 0.2);
        transform: translateY(-2px) scale(1.05);
      }
      .topbar a.social-link:hover::before {
        animation: shimmer 1s;
      }
      .insta-icon {
        display: inline-block;
        margin-right: 4px;
        vertical-align: middle;
      }
      header {
        position: static;
        top: auto;
        z-index: 60;
        border-bottom: 2px solid var(--border);
        background: color-mix(in oklab, var(--bg) 75%, transparent);
        backdrop-filter: saturate(200%) blur(20px);
        -webkit-backdrop-filter: blur(20px);
        box-shadow: 0 8px 32px rgba(0, 212, 255, 0.15);
        width: 100%;
      }
      header::after {
        content: "";
        display: block;
        height: 4px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          var(--accent) 20%,
          var(--accent2) 50%,
          var(--accent) 80%,
          transparent 100%
        );
        box-shadow: 0 0 20px var(--accent);
      }
      .brand {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
        width: 100%;
      }
      .brand-left {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
        flex: 1 1 auto;
      }
      .logo {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: grid;
        place-items: center;
        flex: 0 0 40px;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        border: 2px solid var(--accent2);
        font-weight: 900;
        font-size: 18px;
        color: #fff;
        box-shadow: 0 0 20px var(--glow-strong),
          inset 0 0 20px rgba(255, 255, 255, 0.1);
        animation: glow-pulse 3s ease-in-out infinite;
      }
      h1 {
        font-size: clamp(16px, 2.8vw, 22px);
        margin: 0;
        word-break: break-word;
        color: var(--text);
      }
      .tag {
        color: var(--muted);
        font-size: 12px;
        word-break: break-word;
        max-width: 100%;
      }
      .seg,
      .btn,
      .field,
      select {
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--text);
        min-height: var(--tap);
        outline: none;
        transition: all 0.3s ease;
      }
      .field,
      select {
        background: color-mix(in oklab, var(--card) 90%, var(--bg));
        border-color: var(--border);
        width: 100%;
        font-size: 16px;
      }
      .field:focus,
      select:focus {
        border-color: var(--accent);
        background: color-mix(in oklab, var(--card) 95%, var(--bg));
        box-shadow: 0 0 0 4px
            color-mix(in oklab, var(--accent) 25%, transparent),
          0 0 15px var(--glow);
      }
      .btn,
      .seg {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-weight: 700;
        border-radius: 6px;
        background: var(--chip);
        color: var(--text);
        border: 1px solid var(--border);
        cursor: pointer;
        transition: all 0.3s ease;
        word-break: break-word;
        white-space: normal;
      }
      .btn:hover,
      .seg:hover {
        background: color-mix(in oklab, var(--chip) 140%, var(--accent));
        border-color: var(--accent);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 212, 255, 0.1);
      }
      .btn:active,
      .seg:active {
        transform: translateY(0);
      }
      .btn:focus-visible,
      .seg:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }
      .seg.is-active,
      .seg[aria-pressed="true"] {
        background: color-mix(in oklab, var(--accent) 25%, var(--chip));
        border-color: var(--accent);
        color: var(--accent2);
        box-shadow: 0 0 8px rgba(0, 212, 255, 0.1);
      }
      .btn {
        background: var(--chip);
        color: var(--text);
        border: 1px solid var(--border);
      }
      .btn:hover {
        background: color-mix(in oklab, var(--chip) 120%, var(--accent));
        border-color: var(--accent);
      }
      .muty {
        color: var(--muted);
      }
      .row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        width: 100%;
        box-sizing: border-box;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(
          135deg,
          color-mix(in oklab, var(--chip) 110%, var(--border)),
          var(--chip)
        );
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid var(--border);
        color: var(--text);
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .chip:hover {
        background: linear-gradient(
          135deg,
          color-mix(in oklab, var(--chip) 130%, var(--accent)),
          color-mix(in oklab, var(--chip) 120%, var(--accent))
        );
        border-color: var(--accent);
        box-shadow: 0 0 20px var(--glow);
        transform: translateY(-1px);
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
      }
      .dot.good {
        background: var(--good);
        animation: pulse 2s ease-in-out infinite;
        box-shadow: 0 0 10px var(--good);
      }
      .dot.warn {
        background: var(--warn);
        animation: pulse 2s ease-in-out infinite;
        box-shadow: 0 0 10px var(--warn);
      }
      .dot.error {
        background: var(--error);
        animation: pulse 2s ease-in-out infinite;
        box-shadow: 0 0 10px var(--error);
      }
      #filtersPanel {
        display: grid;
        gap: 8px;
        grid-template-columns: 1fr;
        padding-top: 10px;
        max-height: 500px;
        overflow-y: auto;
      }
      #filtersPanel.hidden {
        display: none;
      }
      @media (min-width: 820px) {
        #filtersPanel {
          display: grid;
          grid-template-columns: 1.2fr 1fr 1fr auto auto auto;
          max-height: none;
        }
        #filtersToggle {
          display: none;
        }
      }
      .quick {
        margin-top: 10px;
        display: grid;
        grid-template-columns: 1fr;
        gap: 6px;
      }
      .quick.hidden {
        display: none;
      }
      @media (min-width: 820px) {
        .quick {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
          gap: 8px;
        }
      }
      .header-toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        margin-top: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border);
      }
      .stats {
        margin-top: 10px;
        display: flex;
        gap: 8px;
        align-items: stretch;
        justify-content: flex-start;
        flex-wrap: wrap;
        color: var(--muted);
        font-size: 13px;
        overflow: hidden;
      }
      .stats .chip {
        font-size: 12px;
        padding: 6px 8px;
        flex: 1 0 auto;
      }
      main {
        max-width: 980px;
        margin: 10px auto calc(80px + var(--safe));
        padding: 0 12px;
        width: 100%;
        box-sizing: border-box;
      }
      .empty,
      .error {
        border: 2px dashed color-mix(in oklab, var(--border) 80%, transparent);
        border-radius: var(--radius);
        padding: 24px;
        color: var(--muted);
        text-align: center;
        background: color-mix(in oklab, var(--card) 60%, var(--bg));
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.1),
          inset 0 0 20px rgba(0, 212, 255, 0.05);
        width: 100%;
        box-sizing: border-box;
      }
      .section {
        margin: 18px 0 26px;
        width: 100%;
        box-sizing: border-box;
      }
      .section h3 {
        margin: 0 0 16px;
        font-size: 18px;
        font-weight: 900;
        color: var(--accent);
        text-transform: uppercase;
        letter-spacing: 0.12em;
        background: linear-gradient(
          90deg,
          var(--accent),
          var(--accent2),
          var(--accent)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        position: relative;
        padding-bottom: 8px;
        filter: drop-shadow(0 0 2px rgba(0, 212, 255, 0.2))
          drop-shadow(0 2px 6px rgba(0, 0, 0, 0.2));
      }
      .section h3::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(
          90deg,
          transparent,
          var(--accent),
          var(--accent2),
          var(--accent),
          transparent
        );
        border-radius: 2px;
        box-shadow: 0 0 8px rgba(0, 212, 255, 0.2);
      }
      .grid {
        display: grid;
        gap: 12px;
        width: 100%;
        box-sizing: border-box;
      }
      .event {
        background: var(--card-gradient);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 14px;
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 12px;
        align-items: flex-start;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        width: 100%;
        box-sizing: border-box;
      }
      .event::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.05),
          transparent
        );
        transition: left 0.5s ease;
      }
      .event:hover::before {
        left: 100%;
      }
      .event:hover,
      .event:focus-within {
        border-color: var(--accent);
        transform: translateY(-3px);
        box-shadow: 0 8px 24px rgba(0, 212, 255, 0.15);
      }
      .event:focus-within {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }
      .pill {
        min-width: 68px;
        border: 1.5px solid var(--accent);
        background: linear-gradient(
          135deg,
          color-mix(in oklab, var(--accent) 18%, var(--pill)),
          color-mix(in oklab, var(--accent) 10%, var(--pill))
        );
        border-radius: 8px;
        text-align: center;
        padding: 8px 6px;
        display: flex;
        flex-direction: column;
        gap: 2px;
        justify-content: center;
        box-shadow: 0 0 12px rgba(0, 212, 255, 0.15),
          inset 0 1px 2px rgba(255, 255, 255, 0.2),
          inset 0 -2px 4px rgba(0, 0, 0, 0.2);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        flex-shrink: 0;
      }
      .pill::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          45deg,
          transparent 40%,
          rgba(255, 255, 255, 0.15) 50%,
          transparent 60%
        );
        pointer-events: none;
        animation: shimmer 12s infinite;
      }
      .pill:hover {
        box-shadow: 0 0 18px rgba(0, 212, 255, 0.25),
          inset 0 1px 3px rgba(255, 255, 255, 0.3),
          inset 0 -2px 4px rgba(0, 0, 0, 0.2);
        transform: translateY(-2px);
      }
      .pill .dow {
        font-weight: 800;
        font-size: 10px;
        color: var(--accent);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        position: relative;
        z-index: 1;
      }
      .pill .day {
        font-size: 24px;
        font-weight: 900;
        color: var(--accent2);
        position: relative;
        z-index: 1;
        text-shadow: 0 0 4px rgba(0, 240, 255, 0.2);
      }
      .pill .mon {
        font-size: 12px;
        font-weight: 700;
        color: var(--accent);
        position: relative;
        z-index: 1;
      }
      .title {
        font-size: 18px;
        font-weight: 700;
        margin: 0 0 4px;
        word-break: break-word;
        color: var(--text);
        overflow-wrap: break-word;
      }
      .title a {
        color: inherit;
        text-decoration: none;
        transition: all 0.3s ease;
        position: relative;
      }
      .title a::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 0;
        height: 2px;
        background: linear-gradient(90deg, var(--accent), var(--accent2));
        transition: width 0.3s ease;
      }
      .title a:hover::after {
        width: 100%;
      }
      .title a:hover {
        color: var(--accent2);
      }
      .title a:focus-visible {
        outline: 2px solid var(--accent);
        border-radius: 4px;
      }
      .meta {
        color: var(--muted);
        font-size: 14px;
        word-break: break-word;
        overflow-wrap: break-word;
      }
      .source {
        color: var(--muted);
        font-size: 12px;
        margin-top: 6px;
        display: flex;
        gap: 4px;
        align-items: center;
        min-width: 0;
        width: 100%;
        box-sizing: border-box;
      }
      .source span:first-child {
        flex-shrink: 0;
      }
      .source span:last-child {
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
      }
      .event-content {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
        flex: 1;
      }
      .card-actions {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: flex-end;
        flex-shrink: 0;
      }
      .btn.free {
        padding: 10px 16px;
        font-size: 13px;
        background: color-mix(in oklab, var(--good) 20%, var(--chip));
        border-color: var(--good);
        color: var(--good);
        box-shadow: 0 0 12px rgba(0, 255, 136, 0.2);
      }
      .btn.free:hover {
        background: color-mix(in oklab, var(--good) 30%, var(--chip));
        border-color: var(--good);
        box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
        transform: translateY(-1px);
      }
      .btn.sold {
        padding: 10px 16px;
        font-size: 13px;
        background: color-mix(in oklab, var(--error) 20%, var(--chip));
        border-color: var(--error);
        color: var(--error);
        box-shadow: 0 0 12px rgba(255, 68, 102, 0.2);
      }
      .btn.sold:hover {
        background: color-mix(in oklab, var(--error) 30%, var(--chip));
        border-color: var(--error);
        box-shadow: 0 0 20px rgba(255, 68, 102, 0.4);
        transform: translateY(-1px);
      }
      .btn.nobook {
        padding: 10px 16px;
        font-size: 13px;
        background: color-mix(in oklab, var(--warn) 20%, var(--chip));
        border-color: var(--warn);
        color: var(--warn);
        box-shadow: 0 0 12px rgba(255, 170, 0, 0.2);
      }
      .btn.nobook:hover {
        background: color-mix(in oklab, var(--warn) 30%, var(--chip));
        border-color: var(--warn);
        box-shadow: 0 0 20px rgba(255, 170, 0, 0.4);
        transform: translateY(-1px);
      }
      .btn.post {
        padding: 10px 16px;
        font-size: 13px;
        background: color-mix(in oklab, var(--accent) 20%, var(--chip));
        border-color: var(--accent);
        color: var(--accent);
        box-shadow: 0 0 12px rgba(0, 212, 255, 0.2);
      }
      .btn.post:hover {
        background: color-mix(in oklab, var(--accent) 30%, var(--chip));
        border-color: var(--accent);
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
        transform: translateY(-1px);
      }
      .btn[data-kind="tickets"] {
        padding: 10px 16px;
        font-size: 13px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 3px;
        background: linear-gradient(
          135deg,
          color-mix(in oklab, var(--accent) 20%, var(--chip)) 0%,
          color-mix(in oklab, var(--accent) 10%, var(--chip)) 100%
        );
        border-color: var(--accent);
        color: var(--accent);
        box-shadow: 0 0 16px rgba(0, 212, 255, 0.25),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
      }
      .btn[data-kind="tickets"]:hover {
        background: linear-gradient(
          135deg,
          color-mix(in oklab, var(--accent) 30%, var(--chip)) 0%,
          color-mix(in oklab, var(--accent) 20%, var(--chip)) 100%
        );
        border-color: var(--accent);
        box-shadow: 0 0 28px rgba(0, 212, 255, 0.5),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
      }
      .btn[data-kind="tickets"] .price {
        font-size: 10px;
        font-weight: 600;
        opacity: 0.9;
        letter-spacing: 0.5px;
      }
      mark {
        background: color-mix(in oklab, var(--accent) 35%, transparent);
        color: inherit;
        padding: 0 0.12em;
        border-radius: 4px;
      }

      @media (max-width: 720px) {
        .wrap {
          padding: 12px;
        }
        .brand {
          gap: 8px;
          flex-direction: column;
          align-items: flex-start;
        }
        .brand-left {
          width: 100%;
        }
        .title {
          font-size: 17px;
        }
        #filtersPanel {
          grid-template-columns: 1fr;
          margin-top: 8px;
          padding: 8px 0;
          border-top: 1px solid var(--border);
        }
        .event {
          grid-template-columns: 1fr;
          padding: 12px;
          gap: 12px;
        }
        .event-content {
          display: flex;
          flex-direction: column;
          gap: 6px;
          min-width: 0;
        }
        .pill {
          order: -1;
          min-width: fit-content;
          flex-direction: row;
          gap: 10px;
          justify-content: center;
          flex-shrink: 0;
          margin: 0 auto;
        }
        .card-actions {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 8px;
          width: 100%;
        }
        .card-actions .btn {
          width: 100%;
          word-break: break-word;
        }
        .quick {
          margin-top: 8px;
          grid-template-columns: 1fr;
          gap: 6px;
          border-top: 1px solid var(--border);
          padding-top: 8px;
        }
        header .row {
          gap: 6px;
          width: 100%;
          flex-wrap: wrap;
        }
        .logo {
          flex-shrink: 0;
        }
        .stats {
          gap: 6px;
          margin-top: 8px;
          padding-top: 8px;
          border-top: 1px solid var(--border);
          font-size: 12px;
        }
        .stats .chip {
          font-size: 11px;
          padding: 4px 6px;
        }
      }
      @media (max-width: 720px) and (min-width: 421px) {
        .card-actions {
          grid-template-columns: repeat(2, 1fr);
          gap: 8px;
        }
      }
      @media (max-width: 420px) {
        .card-actions {
          grid-template-columns: 1fr;
          gap: 6px;
        }
      }
      @media (max-width: 420px) {
        .topbar .wrap {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }
        .topbar-social {
          flex-basis: 100%;
          width: 100%;
        }
        .lead {
          flex-basis: 100%;
          width: 100%;
          font-size: 11px;
        }
        .topbar a {
          font-size: 12px;
          padding: 6px 8px;
        }
        .btn {
          padding: 10px 12px;
          font-size: 12px;
          width: 100%;
        }
        .title {
          font-size: 15px;
        }
        h1 {
          font-size: clamp(14px, 2.8vw, 16px);
        }
        .quick {
          grid-template-columns: 1fr;
          gap: 6px;
        }
        main {
          padding: 0 8px;
        }
        .row {
          gap: 4px;
        }
        .stats {
          gap: 4px;
        }
        .stats .chip {
          font-size: 10px;
          padding: 3px 5px;
        }
        header .row .seg {
          padding: 8px 10px;
          font-size: 12px;
        }
      }
      #fabTop {
        position: fixed;
        right: 8px;
        bottom: calc(8px + var(--safe));
        z-index: 60;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--chip);
        color: var(--text);
        box-shadow: 0 8px 32px var(--glow);
        padding: 10px 14px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 13px;
      }
      #fabTop:hover {
        background: color-mix(in oklab, var(--chip) 140%, var(--accent));
        transform: translateY(-4px);
        box-shadow: 0 12px 40px var(--glow);
        border-color: var(--accent);
      }
      @media (min-width: 721px) {
        #fabTop {
          display: none;
        }
      }
      #toast {
        position: fixed;
        left: 50%;
        bottom: calc(24px + var(--safe));
        transform: translateX(-50%) translateY(16px) scale(0.98);
        background: var(--card);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px 12px;
        box-shadow: 0 8px 32px var(--glow);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.24s ease, transform 0.24s ease;
        z-index: 80;
        font-weight: 700;
      }
      #toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0) scale(1);
      }
      /* NYE closing times grid responsive */
      .nye-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 14px;
      }
      @media (max-width: 768px) {
        .nye-grid {
          grid-template-columns: repeat(auto-fit, minmax(85px, 1fr));
          gap: 10px;
        }
      }
      @media (max-width: 480px) {
        .nye-grid {
          grid-template-columns: repeat(auto-fit, minmax(75px, 1fr));
          gap: 8px;
        }
      }
    </style>
    <script id="events-ld" type="application/ld+json"></script>
  </head>

  <body>
    <!-- Top: email & socials -->
    <div class="topbar">
      <div class="wrap">
        <div class="lead">Bugs? Suggestions? Venue owner?</div>
        <div class="topbar-social">
          <a
            id="contactEmail"
            href="mailto:hu5eventsfinder@gmail.com"
            aria-label="Email HU5 Events Finder"
            >hu5eventsfinder@gmail.com</a
          >
          <a
            id="instagramLink"
            href="https://www.instagram.com/hu5events/"
            target="_blank"
            rel="noopener noreferrer"
            aria-label="Follow HU5 Events on Instagram"
            class="social-link instagram"
            title="Follow us on Instagram"
          >
            <svg
              class="insta-icon"
              viewBox="0 0 24 24"
              width="16"
              height="16"
              fill="currentColor"
            >
              <path
                d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zM5.838 12a6.162 6.162 0 1 1 12.324 0 6.162 6.162 0 0 1-12.324 0zM12 16a4 4 0 1 1 0-8 4 4 0 0 1 0 8zm4.965-10.322a1.44 1.44 0 1 1 2.881.001 1.44 1.44 0 0 1-2.881-.001z"
              />
            </svg>
            Instagram
          </a>
        </div>
      </div>
    </div>

    <!-- Sticky header -->
    <header>
      <div class="wrap">
        <div class="brand">
          <div class="brand-left">
            <div class="logo" aria-hidden="true">H</div>
            <div>
              <h1>HU5 Events Finder</h1>
              <div class="tag">
                HU5 Venues all in one place - built for the community
              </div>
            </div>
          </div>
          <div class="row">
            <button
              id="filtersToggle"
              class="seg"
              aria-expanded="true"
              aria-controls="filtersPanel"
            >
              Filters
            </button>
            <button id="share" class="seg" title="Copy link to this view">
              ðŸ”— Share
            </button>
          </div>
        </div>

        <div id="filtersPanel" role="region" aria-label="Filters">
          <input
            id="q"
            class="field"
            placeholder="Search artist, venue, keywordâ€¦"
            autocomplete="off"
            spellcheck="false"
            aria-label="Search (press / to focus)"
          />
          <input id="from" class="field" type="date" aria-label="From date" />
          <input id="to" class="field" type="date" aria-label="To date" />
          <select id="sort" class="field" aria-label="Sort">
            <option value="date-asc">Soonest first</option>
            <option value="date-desc">Latest first</option>
            <option value="title">Title Aâ†’Z</option>
          </select>
          <select id="venue" class="field" aria-label="Venue">
            <option value="">All venues</option>
          </select>
          <button id="clear" class="seg" title="Reset all filters">
            Clear
          </button>
        </div>

        <div class="quick" role="group" aria-label="Quick ranges">
          <button class="seg" data-range="all" aria-pressed="true">
            All upcoming
          </button>
          <button class="seg" data-range="today">Today</button>
          <button class="seg" data-range="weekend">This weekend</button>
          <button class="seg" data-range="next7">Next 7 days</button>
          <button
            id="toggleUndated"
            class="seg"
            aria-pressed="true"
            title="Show/hide undated"
          >
            Hide undated
          </button>
          <button id="refreshNow" class="seg" title="Reload events.json">
            Refresh
          </button>
        </div>

        <div class="stats" aria-live="polite">
          <div class="row">
            <span class="chip" title="Events shown"
              ><span class="dot good"></span
              ><span id="countText">0 events</span></span
            >
            <span class="chip" title="Last updated"
              ><span class="dot warn"></span
              ><span id="updatedText">â€”</span></span
            >
            <span id="nextRefresh" class="chip" title="Auto-refresh"
              ><span class="dot good"></span
              ><span id="refreshText">Auto refresh on</span></span
            >
          </div>
          <label class="seg" style="gap: 6px"
            ><input
              id="auto"
              type="checkbox"
              style="accent-color: var(--accent)"
              checked
            />
            Auto-refresh</label
          >
        </div>
      </div>
    </header>

    <main class="wrap">
      <div id="status" class="empty" hidden>Loadingâ€¦</div>
      <div id="list" aria-live="polite"></div>
      <button id="fabTop" class="seg" aria-label="Back to filters">
        â†‘ Filters
      </button>
    </main>

    <!-- Private Admin (optional) -->
    <aside
      id="adminPanel"
      role="dialog"
      aria-modal="false"
      aria-label="Site statistics"
      hidden
    >
      <div class="row">
        <h2 style="margin: 4px 0 8px; font-size: 16px">
          Site statistics (private)
        </h2>
        <div class="row" style="gap: 8px">
          <button id="copyStats" class="seg">Copy JSON</button>
          <button id="closeAdmin" class="seg" aria-label="Close">Close</button>
        </div>
      </div>
      <div id="adminSummary" class="muty" style="margin-bottom: 8px"></div>
      <table style="width: 100%; border-collapse: collapse; font-size: 13px">
        <tbody id="adminTable"></tbody>
      </table>
    </aside>

    <div id="toast" role="status" aria-live="polite" aria-atomic="true">
      Link copied
    </div>

    <script>
      (() => {
        function track(eventName, params = {}) {
          try {
            if (typeof gtag === "function") {
              gtag("event", eventName, params);
            }
          } catch (e) {
            // Safe fallback â€“ don't crash the app if analytics fails
            console.warn("track error", e);
          }
        }
        /* =========================== DOM SHORTCUTS =========================== */
        const $ = (s, el = document) => el.querySelector(s);
        const $$ = (s, el = document) => Array.from(el.querySelectorAll(s));

        /* ============================== STATE =============================== */
        const state = {
          TZ: "Europe/London",
          all: [], // raw events from events.json + computed fields
          view: [], // filtered/sorted events for current view
          autoRefresh: true,
          refreshMs: 5 * 60 * 1000,
          nextTickAt: null,
          lastUpdated: null,
          range: "all",
          showUndated: true,
          sort: "date-asc",
          stats: {
            loads: 0,
            lastLoadMs: 0,
            lastRenderMs: 0,
            totalEvents: 0,
            datedEvents: 0,
            undatedEvents: 0,
            venues: {},
            filtersUsed: 0,
            lastAppliedAt: null,
          },
          isAdmin: false,
        };
        Object.defineProperty(window, "state", { get: () => state });

        const els = {
          list: $("#list"),
          status: $("#status"),
          countText: $("#countText"),
          updatedText: $("#updatedText"),
          refreshText: $("#refreshText"),
          auto: $("#auto"),
          q: $("#q"),
          from: $("#from"),
          to: $("#to"),
          sort: $("#sort"),
          venue: $("#venue"),
          rangeButtons: $$(".quick .seg[data-range]"),
          toggleUndated: $("#toggleUndated"),
          refreshNow: $("#refreshNow"),
          clear: $("#clear"),
          share: $("#share"),
          filtersPanel: $("#filtersPanel"),
          filtersToggle: $("#filtersToggle"),
          admin: $("#adminPanel"),
          adminTable: $("#adminTable"),
          adminSummary: $("#adminSummary"),
          copyStats: $("#copyStats"),
          closeAdmin: $("#closeAdmin"),
          fabTop: $("#fabTop"),
          toast: $("#toast"),
          contactEmail: $("#contactEmail"),
        };

        const STORAGE_KEY = "hu5-filters-vEffStart";
        const ADMIN_KEY = "hu5-admin";

        /* ============================= HELPERS ============================== */
        const escapeHTML = (s) =>
          s == null
            ? ""
            : String(s)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#39;");
        const parseMaybe = (iso) => {
          if (!iso) return null;
          const d = new Date(iso);
          return isNaN(d.getTime()) ? null : d;
        };
        const timeAgo = (d) => {
          if (!d) return "â€”";
          const ms = Date.now() - d.getTime(),
            m = Math.round(ms / 60000);
          if (m < 1) return "just now";
          if (m < 60) return `${m} min ago`;
          const h = Math.round(m / 60);
          if (h < 24) return `${h} hr${h > 1 ? "s" : ""} ago`;
          const days = Math.round(h / 24);
          return `${days} day${days > 1 ? "s" : ""} ago`;
        };
        const startOfTodayLocal = () => {
          const n = new Date();
          return new Date(
            n.getFullYear(),
            n.getMonth(),
            n.getDate(),
            0,
            0,
            0,
            0
          );
        };

        function toLocalISO(d) {
          if (!(d instanceof Date) || isNaN(+d)) return null;
          const pad = (n) => String(n).padStart(2, "0");
          const tz = -d.getTimezoneOffset(); // minutes
          const sign = tz >= 0 ? "+" : "-";
          const hh = pad(Math.floor(Math.abs(tz) / 60));
          const mm = pad(Math.abs(tz) % 60);
          return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(
            d.getDate()
          )}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(
            d.getSeconds()
          )}${sign}${hh}:${mm}`;
        }

        function buildICS(ev) {
          const start = ev._startEff || parseMaybe(ev.start);
          if (!start) return null;
          const end = ev.end
            ? parseMaybe(ev.end)
            : new Date(start.getTime() + 2 * 60 * 60 * 1000);

          const dt = (d) => {
            const p = (n) => String(n).padStart(2, "0");
            return `${d.getUTCFullYear()}${p(d.getUTCMonth() + 1)}${p(
              d.getUTCDate()
            )}T${p(d.getUTCHours())}${p(d.getUTCMinutes())}${p(
              d.getUTCSeconds()
            )}Z`;
          };

          const lines = [
            "BEGIN:VCALENDAR",
            "VERSION:2.0",
            "PRODID:-//Find HU5 Events//EN",
            "BEGIN:VEVENT",
            `UID:${ev._id}@findhu5.events`,
            `DTSTAMP:${dt(new Date())}`,
            `DTSTART:${dt(start)}`,
            end ? `DTEND:${dt(end)}` : null,
            `SUMMARY:${(ev.title || "Event").replace(/\r?\n/g, " ")}`,
            ev.venue
              ? `LOCATION:${(
                  ev.venue + (ev.address ? ", " + ev.address : "")
                ).replace(/\r?\n/g, " ")}`
              : null,
            isMeaningfulLink(ev.url) ? `URL:${ev.url}` : null,
            "END:VEVENT",
            "END:VCALENDAR",
          ]
            .filter(Boolean)
            .join("\r\n");

          return new Blob([lines], { type: "text/calendar" });
        }

        function isMeaningfulLink(url) {
          if (!url) return false;
          try {
            const u = new URL(url, location.href);
            if (!/^https?:$/.test(u.protocol)) return false; // no mailto:, tel:, etc
            const sameOrigin = u.origin === location.origin;
            if (sameOrigin) return false; // donâ€™t link back to the finder itself
            // if itâ€™s clearly an anchor or empty-ish path, also skip
            if (!u.hostname || u.pathname === "/") return true; // external homepages allowed
            return true;
          } catch {
            return false;
          }
        }

        const isFacebookUrl = (url = "") =>
          /^(https?:\/\/)?(www\.)?(m\.)?facebook\.com\//i.test(String(url));

        // Venues that are known to be free entry by default (unless scraper detects paid/sold out)
        const DEFAULT_FREE_VENUES = new Set([
          "The People's Republic",
          "Commun'ull",
          "Hoi",
          "Vox Box",
          "Mr Moody's Tavern",
          "Molly Mangan's",
        ]);

        // Normalise venue labels across sources (for filtering chip)
        // Normalize venue names from scraper data to canonical labels for consistent display/filtering
        function venueLabel(ev) {
          const raw = (ev.venue || ev.source || "")
            .toLowerCase()
            .replace(/[â€™']/g, "'");
          if (/\bwelly\b|giveitsomewelly/.test(raw)) return "The Welly Club";
          if (/\badelphi\b/.test(raw)) return "The New Adelphi Club";
          if (/\bpolar\b/.test(raw)) return "Polar Bear Music Club";
          if (/\bpeople'?s republic\b/.test(raw))
            return "The People's Republic";
          if (/\bvox\s*box\b|voxboxbar\.co\.uk/.test(raw)) return "Vox Box";
          if (/\bunion\s*mash\s*up\b|unionmashup\.co\.uk/.test(raw))
            return "Union Mash Up";
          if (/\bcommun'ull\b/.test(raw)) return "Commun'ull";
          if (/\bmr\s*moody'?s\b/.test(raw)) return "Mr Moody's Tavern";
          if (/\bhoi\b/.test(raw)) return "Hoi";
          if (/\bdive\b.*hu5|skiddle\.com\/whats-on\/hull\/dive-hu5/i.test(raw))
            return "DIVE HU5";
          return ev.venue || ev.source || "Other";
        }

        const VENUE_ALIASES = {
          "The New Adelphi Club": /\badelphi\b/i, // matches "Adelphi", "The Adelphi Club in Hull", etc.
          "Polar Bear Music Club": /\bpolar\s*bear\b/i,
          "The Welly Club": /\bwelly\b/i,
          "Vox Box": /\bvox\s*box\b/i,
          "Union Mash Up": /\bunion\s*mash\s*up\b|\bumu\b/i,
          "The People's Republic": /\bpeople'?s\s*republic\b|\btpr\b/i,
          "Mr Moody's Tavern": /\bmoody'?s\b/i,
          Hoi: /\bhoi\b/i,
          "DIVE HU5": /\bdive\b.*\bhu5\b/i,
        };

        // Append venue to title unless the title already obviously contains it
        function ensureVenueInTitle(title, venue) {
          const t = String(title || "");
          const v = String(venue || "").trim();
          if (!v) return t;

          // If we have a known alias/regex and it matches the title, don't append
          const alias = VENUE_ALIASES[v];
          if (alias && alias.test(t)) return t;

          // Generic fuzzy match fallback
          const norm = (s) =>
            s
              .toLowerCase()
              .replace(/the\s+/g, "")
              .replace(/\b(club|bar|venue)\b/g, "")
              .replace(/[^a-z0-9]+/g, " ")
              .trim();

          if (norm(t).includes(norm(v))) return t;

          return `${t} â€” ${v}`;
        }

        // ICS-like URLs? then link to listings page instead
        const isIcsLike = (url = "") =>
          /\.(ics)(\?|$)/i.test(url) ||
          /[?&]format=ical(\b|=|&|$)/i.test(url) ||
          /(?:^|\/\/)calendar\.google\.com|google\.com\/calendar/i.test(url);
        function toListingsUrl(url, source) {
          if (!url) return "#";
          if (!isIcsLike(url)) return url;
          try {
            const u = new URL(url, location.href);
            if (/[?&]format=ical\b/i.test(u.search))
              return u.origin + u.pathname;
          } catch {}
          const s = (source || "").toLowerCase();
          if (
            url.includes("polarbearmusicclub.co.uk") ||
            s.includes("polar bear")
          )
            return "https://www.polarbearmusicclub.co.uk/whatson";
          if (url.includes("giveitsomewelly.com") || s.includes("welly"))
            return "https://www.giveitsomewelly.com/shows/";
          if (url.includes("theadelphi.com") || s.includes("adelphi"))
            return "https://www.theadelphi.com/events/";
          if (url.includes("unionmashup.co.uk") || s.includes("union mash up"))
            return "https://unionmashup.co.uk/umu-events/";
          if (
            /skiddle\.com\/whats-on\/hull\/dive-hu5/i.test(url) ||
            s.includes("dive")
          )
            return "https://www.skiddle.com/whats-on/Hull/DIVE-HU5/";
          return url;
        }

        // Build Google Calendar link when we have a start time
        const toGCalDateISO = (d) => {
          if (!d) return null;
          const p = (n) => String(n).padStart(2, "0");
          return (
            d.getUTCFullYear() +
            p(d.getUTCMonth() + 1) +
            p(d.getUTCDate()) +
            "T" +
            p(d.getUTCHours()) +
            p(d.getUTCMinutes()) +
            p(d.getUTCSeconds()) +
            "Z"
          );
        };
        function googleHref(ev) {
          if (!ev) return null;
          const start = ev._startEff || parseMaybe(ev.start);
          const end =
            ev && ev.end
              ? parseMaybe(ev.end)
              : start
              ? new Date(start.getTime() + 2 * 60 * 60 * 1000)
              : null;
          if (!start || !end) return null;

          const s = toGCalDateISO(start),
            e = toGCalDateISO(end);
          const title = encodeURIComponent((ev && ev.title) || "Event");
          const loc = encodeURIComponent(
            [ev && ev.venue, ev && ev.address].filter(Boolean).join(", ")
          );
          const details = encodeURIComponent((ev && ev.url) || "");
          return (
            "https://www.google.com/calendar/event?action=TEMPLATE&text=" +
            title +
            "&dates=" +
            s +
            "/" +
            e +
            "&location=" +
            loc +
            "&details=" +
            details
          );
        }

        // Highlight matching query text
        function highlight(text, query) {
          if (!text) return "";
          if (!query) return escapeHTML(text);
          const q = query.trim().replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
          if (!q) return escapeHTML(text);
          return escapeHTML(text).replace(
            new RegExp(`(${q})`, "ig"),
            "<mark>$1</mark>"
          );
        }

        // Free / Sold-out detectors
        function isFreeEvent(ev) {
          if (!ev || typeof ev !== "object") return false;

          // hard flags first
          if (ev.freeEntry === true || ev.free === true || ev.isFree === true)
            return true;

          const vName = venueLabel(ev);
          const isAdelphi =
            /\badelphi\b/i.test(
              String(ev.source || "") + " " + String(ev.venue || "")
            ) || /theadelphi\.com/i.test(String(ev.url || ""));
          const isTPR = vName === "The People's Republic";
          const isCommunull = vName === "Commun'ull";

          // gather text (tight vs wide)
          const fieldsTight = [
            ev.price,
            ev.priceText,
            ev.entry,
            ev.admission,
            ev.cost,
            ev.tags,
            ev.notes,
            ev.badges,
            ev.title,
          ].filter(Boolean);
          const fieldsWide = [ev.description, ev.meta].filter(Boolean);

          const scan = (arr) =>
            arr
              .map((x) => (Array.isArray(x) ? x.join(" ") : String(x)))
              .join(" ")
              .toLowerCase();

          const tight = scan(fieldsTight);
          const wide = scan(fieldsWide);

          // positive free signals
          const freeTight =
            /\bfree(?:\s*(entry|admission|tickets?))?\b/.test(tight) ||
            /\bno\s*cover\b/.test(tight) ||
            /(?:^|\b)(Â£|\$|â‚¬)\s*0(?:\.00)?\b/.test(tight) ||
            /\b0(?:\.00)?\s*(gbp|usd|eur)?\b/.test(tight);

          const freeWide =
            !isAdelphi && // stay strict for Adelphi
            (/\bfree(?:\s*(entry|admission|tickets?))?\b/.test(wide) ||
              /(?:^|\b)(Â£|\$|â‚¬)\s*0(?:\.00)?\b/.test(wide));

          const hasFreeSignal = freeTight || freeWide;

          // paid-ish signals
          const anyPriceOverZero =
            /\b(Â£|\$|â‚¬)\s*\d{1,3}(?:\.\d{2})?\b/.test(tight + " " + wide) &&
            !/(?:^|\b)(Â£|\$|â‚¬)\s*0(?:\.00)?\b/.test(tight + " " + wide);

          const hasPaidCue =
            /\b(adv|advance|otd|door|on\s*the\s*door|tickets?\s*from)\b/i.test(
              tight + " " + wide
            );

          const soldish =
            /(sold\s*out|sold-out|no\s*tickets|fully\s*booked|at\s*capacity)/i.test(
              tight + " " + wide
            );

          if (anyPriceOverZero || hasPaidCue || soldish) return false;
          if (hasFreeSignal) return true;

          // âœ… default-to-free for TPR & Communâ€™ull when we have no ticket/cost info
          if (DEFAULT_FREE_VENUES.has(vName) && !hasTicketOrCostInfo(ev)) {
            return true;
          }

          return false;
        }

        function isSoldOut(ev) {
          if (!ev || typeof ev !== "object") return false;
          if (ev.soldOut === true || ev.sold_out === true) return true;
          if (
            ev.availability &&
            String(ev.availability).toLowerCase().includes("sold")
          )
            return true;

          const fields = [
            ev.status,
            ev.notes,
            ev.title,
            ev.description,
            ev.badges,
            ev.meta,
          ];
          if (Array.isArray(ev.tickets)) {
            for (const t of ev.tickets)
              fields.push(t?.status, t?.label, t?.note, t?.text, t?.type);
          }
          const big = fields
            .filter(Boolean)
            .map((x) => (Array.isArray(x) ? x.join(" ") : String(x)))
            .join(" ")
            .toLowerCase();

          return (
            /(sold\s*out|sold-out|no\s*tickets|fully\s*booked|at\s*capacity|sold\b)/i.test(
              big
            ) ||
            /\btickets?\s*(?:are\s*)?no\s*longer\s*available\b/i.test(big) || // Adelphi phrase
            /\b(sales?|booking)\s*closed\b/i.test(big)
          );
        }

        function hasTicketOrCostInfo(ev) {
          if (!ev || typeof ev !== "object") return false;

          // treat Commun'ull Facebook links as NOT ticket/cost info
          const vName = venueLabel(ev);
          const tObj = Array.isArray(ev.tickets)
            ? ev.tickets.find((t) => t && (t.url || t.link))
            : null;
          const tUrl =
            ev.ticketUrl ||
            ev.ticketsUrl ||
            ev.linkTickets ||
            tObj?.url ||
            tObj?.link ||
            "";

          if (DEFAULT_FREE_VENUES.has(vName) && isFacebookUrl(tUrl)) {
            return false;
          }

          // Obvious structured fields
          if (ev.ticketUrl || ev.ticketsUrl || ev.linkTickets) return true;
          const priceFields = [
            ev.price,
            ev.priceText,
            ev.entry,
            ev.admission,
            ev.cost,
          ];
          if (priceFields.some((v) => v && String(v).trim() !== ""))
            return true;

          if (
            Array.isArray(ev.tickets) &&
            ev.tickets.some(
              (t) => t && (t.url || t.link || t.price || t.status)
            )
          ) {
            return true;
          }

          // Text scan â€¦
          const big = [ev.title, ev.description, ev.notes, ev.meta, ev.badges]
            .filter(Boolean)
            .map((x) => (Array.isArray(x) ? x.join(" ") : String(x)))
            .join(" ")
            .toLowerCase();

          if (/[Â£$â‚¬]\s*\d/.test(big)) return true;
          if (/\b\d{1,3}\s*(gbp|eur|usd|pounds?|quid)\b/.test(big)) return true;
          if (
            /\btickets?\s*(?:on\s*sale|available|adv|otd|door|entry|buy|book)\b/.test(
              big
            )
          )
            return true;
          if (/\btickets?\s*(?:are\s*)?no\s*longer\s*available\b/.test(big))
            return true;

          return false;
        }

        function isPostponed(ev) {
          if (!ev || typeof ev !== "object") return false;
          if (isSoldOut(ev)) return false; // prefer sold-out if both appear
          const explicit =
            ev.postponed === true ||
            /^(postponed|rescheduled)$/i.test(String(ev.status || ""));
          const byBadge =
            Array.isArray(ev.badges) &&
            ev.badges.some((x) => /^(postponed)$/i.test(String(x || "")));
          return explicit || byBadge;
        }

        function isNoBookingsEvent(ev) {
          if (venueLabel(ev) !== "Mr Moody's Tavern") return false;
          const t = (ev.title || "").toLowerCase().replace(/[^a-z]+/g, " ");
          return t.includes("sunday") && t.includes("lunch");
        }

        /* =================== SMART DATE/TIME PARSERS (UI) =================== */
        // Parse "YYYY-MM-DD HH:mm" to a local Date
        function parseDateTime24Local(s = "") {
          if (!s) return null;
          const txt = String(s).trim();
          // Accept space or 'T' separator; optional seconds
          const m = txt.match(
            /^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})(?::(\d{2}))?$/
          );
          if (!m) return null;
          const Y = Number(m[1]);
          const Mo = Number(m[2]);
          const D = Number(m[3]);
          const H = Number(m[4]);
          const Mi = Number(m[5]);
          const Ss = Number(m[6] || 0);
          const d = new Date(Y, Mo - 1, D, H, Mi, Ss, 0);
          return isNaN(d.getTime()) ? null : d;
        }

        /**
         * Parse a human date (DD/MM[/YY], "15 Sep", "Mon 15 September", "YYYY-MM-DD") plus a time snippet.
         * timeText can be 12/24h or "doors 9pm". Defaults to 20:00 when not provided.
         */
        function parseDateText(dateText, timeText) {
          const monthMap = {
            jan: 0,
            feb: 1,
            mar: 2,
            apr: 3,
            may: 4,
            jun: 5,
            jul: 6,
            aug: 7,
            sep: 8,
            sept: 8,
            oct: 9,
            nov: 10,
            dec: 11,
          };
          const clean = (s = "") =>
            String(s)
              .replace(/\u00A0/g, " ")
              .replace(/\s+/g, " ")
              .trim();

          const dTxt = clean(dateText);
          const tTxt = clean(timeText);

          if (!dTxt) return null;

          // ---- Time parse (default 20:00) ----
          let hh = 20,
            mm = 0;
          if (tTxt) {
            const t = tTxt.toLowerCase().replace(/\./g, ":");
            let m;

            // "9:30 pm"
            m = t.match(/\b(\d{1,2})(?::(\d{2}))\s*(am|pm)\b/i);
            if (m) {
              hh = Number(m[1]);
              mm = Number(m[2] || 0);
              const ap = m[3].toLowerCase();
              if (ap === "pm" && hh !== 12) hh += 12;
              if (ap === "am" && hh === 12) hh = 0;
            } else if ((m = t.match(/\b(\d{1,2})\s*(am|pm)\b/i))) {
              // "9 pm"
              hh = Number(m[1]);
              const ap = m[2].toLowerCase();
              if (ap === "pm" && hh !== 12) hh += 12;
              if (ap === "am" && hh === 12) hh = 0;
            } else if ((m = t.match(/\b(\d{1,2}):(\d{2})\b/))) {
              // "21:00"
              hh = Math.min(23, Math.max(0, Number(m[1])));
              mm = Math.min(59, Math.max(0, Number(m[2])));
            } else if (
              (m = t.match(
                /\bdoors?\s*[:\-]?\s*(\d{1,2})(?::(\d{2}))?\s*(am|pm)?\b/i
              ))
            ) {
              // "doors 9", "doors 9pm"
              hh = Number(m[1]);
              mm = Number(m[2] || 0);
              if (m[3]) {
                const ap = m[3].toLowerCase();
                if (ap === "pm" && hh !== 12) hh += 12;
                if (ap === "am" && hh === 12) hh = 0;
              } else if (hh >= 5 && hh <= 11) {
                // evening bias if no am/pm
                hh += 12;
              }
            }
          }

          const today = new Date();
          const today0 = startOfTodayLocal();

          // Helper to roll forward a no-year date that ended up in the past
          const rollIfPastNoYear = (dt, hadYear) => {
            if (!dt || isNaN(+dt)) return null;
            if (!hadYear && +dt < +today0) dt.setFullYear(dt.getFullYear() + 1);
            return dt;
          };

          // ---- Accept ISO date (YYYY-MM-DD) in dateText directly ----
          let m = dTxt.match(/\b(\d{4})-(\d{2})-(\d{2})\b/);
          if (m) {
            const Y = Number(m[1]);
            const Mo = Number(m[2]);
            const D = Number(m[3]);
            const dt = new Date(Y, Mo - 1, D, hh, mm, 0, 0);
            return isNaN(+dt) ? null : dt;
          }

          // ---- DD/MM[/YY] or DD/MM/YYYY (YY -> 20YY) ----
          m = dTxt.match(/\b(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?\b/);
          if (m) {
            const day = Number(m[1]);
            const mon = Number(m[2]) - 1;
            let year = m[3] ? Number(m[3]) : today.getFullYear();
            const hadYear = !!m[3];
            if (m[3] && m[3].length === 2) year = 2000 + Number(m[3]);
            const dt = new Date(year, mon, day, hh, mm, 0, 0);
            return rollIfPastNoYear(dt, hadYear);
          }

          // ---- "Mon 15 Sep [YY|YYYY]" or "15 September [YY|YYYY]" (with ordinals) ----
          m = dTxt
            .replace(/\b(\d{1,2})(st|nd|rd|th)\b/gi, "$1")
            .match(
              /\b(?:(?:mon|tue|wed|thu|fri|sat|sun)\w*\s+)?(\d{1,2})\s+([a-z]{3,9})(?:\s+(\d{2,4}))?\b/i
            );

          if (m) {
            const day = Number(m[1]);
            const monKey =
              m[2].toLowerCase().slice(0, 4) === "sept"
                ? "sept"
                : m[2].toLowerCase().slice(0, 3);
            const mon = monthMap[monKey];
            if (mon != null) {
              let year = m[3] ? Number(m[3]) : today.getFullYear();
              const hadYear = !!m[3];
              if (m[3] && m[3].length === 2) year = 2000 + Number(m[3]);
              const dt = new Date(year, mon, day, hh, mm, 0, 0);
              return rollIfPastNoYear(dt, hadYear);
            }
          }

          return null;
        }

        // Compute effective start for an event (used for filtering + grouping)
        function computeEffectiveStart(ev) {
          if (!ev || typeof ev !== "object") return null;

          // A) ISO-ish fields straight from sources
          const iso =
            ev.start ||
            ev.startISO ||
            ev.start_iso ||
            ev.startDate ||
            ev.start_date ||
            ev.start_time ||
            null;
          const a = parseMaybe(iso);
          if (a) return a;

          // B) Explicit "YYYY-MM-DD HH:mm"
          const b = parseDateTime24Local(
            ev.displayDateTime24 || ev.displayDateTime || ""
          );
          if (b) return b;

          // C) Spreadsheet-style: accept several date fields + a time snippet.
          //    parseDateText defaults time to 20:00 if none given.
          const bestTime =
            ev.displayTime24 || ev.timeText || ev.time || ev.time_text || "";
          const dateTextField =
            ev.dateText || // old path
            ev.date || // âœ¨ spreadsheet "date"
            ev.dateOnly || // âœ¨ spreadsheet "dateOnly" (YYYY-MM-DD)
            ev.when ||
            ev.day || // loose fallbacks
            "";

          const c = parseDateText(dateTextField, bestTime);
          if (c) return c;

          // D) Last-ditch: if we have a clean YYYY-MM-DD anywhere, try it with whatever time we have
          if (ev.dateOnly && /^\d{4}-\d{2}-\d{2}$/.test(ev.dateOnly)) {
            const d = parseDateText(ev.dateOnly, bestTime);
            if (d) return d;
          }

          return null;
        }

        // Email mailto pre-fill
        function updateMailto() {
          if (!els.contactEmail) return;
          const subject = "HU5 Events Finder â€” Idea / Bug / Venue request";
          const bodyLines = [
            "Hello,",
            "",
            "Type: [Idea / Bug / Venue request]",
            "Details:",
            "",
            `Current view: ${location.href}`,
            `Browser: ${navigator.userAgent}`,
          ];
          const mailto = `mailto:hu5eventsfinder@gmail.com?subject=${encodeURIComponent(
            subject
          )}&body=${encodeURIComponent(bodyLines.join("\n"))}`;
          els.contactEmail.setAttribute("href", mailto);
        }

        // Shareable filters in URL
        function filtersToParams() {
          const o = {
            q: els.q.value || "",
            from: els.from.value || "",
            to: els.to.value || "",
            sort: els.sort.value || "date-asc",
            venue: els.venue.value || "",
            range: state.range || "all",
            undated: state.showUndated ? "1" : "0",
          };
          const params = new URLSearchParams();
          Object.entries(o).forEach(([k, v]) => {
            if (String(v).trim() !== "") params.set(k, v);
          });
          return params.toString();
        }

        function paramsToFilters(u) {
          try {
            const p = new URL(u, location.href).searchParams;
            const val = (k, def = "") => p.get(k) ?? def;
            const has = (k) => p.has(k);

            if (has("q")) els.q.value = val("q");
            if (has("from")) els.from.value = val("from");
            if (has("to")) els.to.value = val("to");
            if (has("sort")) els.sort.value = val("sort");
            if (has("venue")) els.venue.value = val("venue");
            if (has("range")) state.range = val("range");
            if (has("undated")) state.showUndated = val("undated") !== "0";
          } catch (e) {
            console.warn("paramsToFilters failed:", e);
          }
        }

        function replaceUrl() {
          const qs = filtersToParams();
          const base = location.origin + location.pathname;
          history.replaceState(null, "", qs ? `${base}?${qs}` : base);
        }

        /* ============================== FETCH =============================== */
        async function fetchEventsJson() {
          const t0 = performance.now();
          const maxRetries = 3;
          let lastError;

          for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
              const res = await fetch("events.json?ts=" + Date.now(), {
                cache: "no-store",
              });
              if (!res.ok)
                throw new Error(`Failed to load events.json (${res.status})`);
              const txt = await res.text();
              let data;
              try {
                data = JSON.parse(txt);
              } catch {
                throw new Error("Invalid JSON in events.json");
              }
              let updated = null;
              if (Array.isArray(data)) {
                try {
                  const most = data.reduce(
                    (m, e) =>
                      Math.max(m, e?.scrapedAt ? +new Date(e.scrapedAt) : 0),
                    0
                  );
                  if (most) updated = new Date(most);
                } catch {}
              }
              if (!updated) {
                const hdr =
                  res.headers.get("Last-Modified") || res.headers.get("Date");
                if (hdr) updated = new Date(hdr);
              }
              state.lastUpdated = updated || new Date();
              state.stats.loads += 1;
              state.stats.lastLoadMs = Math.round(performance.now() - t0);
              return Array.isArray(data) ? data : [];
            } catch (e) {
              lastError = e;
              if (attempt < maxRetries - 1) {
                const delayMs = Math.pow(2, attempt) * 1000;
                console.warn(
                  `[fetch] Attempt ${
                    attempt + 1
                  } failed, retrying in ${delayMs}msâ€¦`,
                  e.message
                );
                await new Promise((resolve) => setTimeout(resolve, delayMs));
              }
            }
          }

          throw (
            lastError ||
            new Error("Failed to fetch events.json after 3 attempts")
          );
        }

        /* ============================ RENDERING ============================= */
        function groupByDate(items, sortKey) {
          const fmt = new Intl.DateTimeFormat("en-GB", {
            timeZone: state.TZ,
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
          });
          const dated = items.filter((ev) => ev._hasDate);
          const undated = items.filter((ev) => !ev._hasDate);
          const groups = new Map();

          for (const ev of dated) {
            const d = ev._startEff;
            const parts = fmt
              .formatToParts(d)
              .reduce((acc, p) => ((acc[p.type] = p.value), acc), {});
            const key = `${parts.year}-${parts.month}-${parts.day}`;
            if (!groups.has(key)) groups.set(key, []);
            groups.get(key).push(ev);
          }

          let ordered = Array.from(groups.entries());
          if (sortKey === "date-desc")
            ordered.sort(([a], [b]) => b.localeCompare(a));
          else ordered.sort(([a], [b]) => a.localeCompare(b));

          if (state.showUndated && undated.length)
            ordered.push(["Undated", undated]);
          return ordered;
        }

        function injectLD() {
          try {
            const today0 = startOfTodayLocal();

            const items = state.all
              // only events with a computed date
              .filter(
                (e) =>
                  e._hasDate &&
                  e._startEff instanceof Date &&
                  !isNaN(+e._startEff)
              )
              // only upcoming events
              .filter((e) => +e._startEff >= +today0)
              .slice(0, 100)
              .map((ev) => {
                // ----- URLs -----
                const ticketObj = Array.isArray(ev.tickets)
                  ? ev.tickets.find((t) => t && (t.url || t.link))
                  : null;

                const ticketUrl =
                  ticketObj?.url ||
                  ticketObj?.link ||
                  ev.ticketUrl ||
                  ev.ticketsUrl ||
                  ev.linkTickets ||
                  null;

                const openHref = toListingsUrl(ev.url || "", ev.source);

                // ----- start / end dates -----
                const start = ev._startEff || parseMaybe(ev.start);
                let end = null;

                if (ev.end) {
                  end = parseMaybe(ev.end);
                }
                if (!end && start) {
                  // default duration: 2h
                  end = new Date(start.getTime() + 2 * 60 * 60 * 1000);
                }

                // ----- description -----
                let description =
                  (ev.description && String(ev.description)) ||
                  (ev.meta && String(ev.meta)) ||
                  "";

                if (!description.trim()) {
                  const bits = [];
                  bits.push(ev.title || "Event");
                  const venueName = ev.venue || venueLabel(ev);
                  if (venueName) bits.push(`at ${venueName}`);
                  bits.push("in HU5, Hull.");
                  description = bits.join(" ");
                }

                // ----- image(s) -----
                const rawImage =
                  ev.image ||
                  ev.imageUrl ||
                  ev.coverImage ||
                  "https://www.findhu5.events/og-preview.png";
                const image = Array.isArray(rawImage) ? rawImage : [rawImage];

                // ----- venue / organizer -----
                const venueName = ev.venue || venueLabel(ev) || "HU5 venue";

                const organizerUrl =
                  ev.organizerUrl ||
                  ev.venueUrl ||
                  (isMeaningfulLink(openHref) && !isIcsLike(openHref)
                    ? openHref
                    : "https://www.findhu5.events/");

                const ld = {
                  "@type": "Event",
                  name: ev.title || "Event",
                  description,
                  startDate: start ? start.toISOString() : undefined,
                  endDate: end ? end.toISOString() : undefined,
                  eventAttendanceMode:
                    "https://schema.org/OfflineEventAttendanceMode",
                  eventStatus: isPostponed(ev)
                    ? "https://schema.org/EventPostponed"
                    : "https://schema.org/EventScheduled",
                  location: {
                    "@type": "Place",
                    name: venueName,
                    address: {
                      "@type": "PostalAddress",
                      streetAddress: ev.address || "HU5",
                      addressLocality: "Hull",
                      addressRegion: "East Yorkshire",
                      postalCode: "HU5",
                      addressCountry: "GB",
                    },
                  },
                  image,
                  url: isMeaningfulLink(openHref)
                    ? openHref
                    : "https://www.findhu5.events/",
                  organizer: venueName
                    ? {
                        "@type": "Organization",
                        name: venueName,
                        url: organizerUrl,
                      }
                    : undefined,
                };

                // ----- performer -----
                const performerName =
                  ev.artist || ev.performer || ev.headline || ev.title;
                if (performerName) {
                  ld.performer = [
                    {
                      "@type": "PerformingGroup",
                      name: performerName,
                    },
                  ];
                }

                // ----- offers (free / tickets) -----
                if (isFreeEvent(ev)) {
                  ld.offers = {
                    "@type": "Offer",
                    price: "0",
                    priceCurrency: "GBP",
                    availability: "https://schema.org/InStock",
                    url: isMeaningfulLink(openHref) ? openHref : undefined,
                  };
                } else if (isMeaningfulLink(ticketUrl)) {
                  ld.offers = {
                    "@type": "Offer",
                    url: ticketUrl,
                    availability: isSoldOut(ev)
                      ? "https://schema.org/SoldOut"
                      : "https://schema.org/InStock",
                  };

                  const p = ev.price || ev.priceText || ev.admission || ev.cost;
                  if (p && /(\d+(?:\.\d{2})?)/.test(String(p))) {
                    ld.offers.price = RegExp.$1;
                    ld.offers.priceCurrency = "GBP";
                  }
                }

                return ld;
              });

            const el = document.getElementById("events-ld");
            if (!el) return;

            const payload = {
              "@context": "https://schema.org",
              "@graph": items,
            };

            el.textContent = JSON.stringify(payload);
          } catch (err) {
            console.warn("injectLD failed", err);
          }
        }

        function render() {
          const t0 = performance.now();
          const n = state.view.length;

          els.countText.textContent = `${n} event${n === 1 ? "" : "s"}`;
          els.refreshText.textContent = state.autoRefresh
            ? "Auto refresh on"
            : "Auto refresh off";
          els.updatedText.textContent = state.lastUpdated
            ? `Updated ${timeAgo(
                state.lastUpdated
              )} (${state.lastUpdated.toLocaleString()})`
            : "â€”";

          if (!n) {
            els.list.innerHTML = `<div class="empty">No events match your filters. <button class="seg" id="resetBtn">Reset</button></div>`;
            $("#resetBtn")?.addEventListener("click", () => {
              resetFilters();
              apply();
            });
            replaceUrl();
            updateMailto();
            return;
          }

          // time display helpers
          const to24h = (raw) => {
            if (!raw) return null;

            let s = String(raw).trim().toLowerCase();

            // ---- Strip prices BEFORE any dotâ†’colon conversion ----
            // Â£10, Â£10.20, 10.20 adv, Â£10/Â£12, 10/12, etc.
            s = s
              // Â£x.xx or Â£x (optionally with / Â£y.xx)
              .replace(
                /Â£\s*\d{1,3}(?:\.\d{2})?(?:\s*\/\s*Â£?\s*\d{1,3}(?:\.\d{2})?)*/g,
                ""
              )
              // bare decimals that are clearly prices when followed by fee/ticket words
              .replace(
                /\b\d{1,3}\.\d{2}\b(?=\s*(?:adv|otd|door|entry|tickets?|\+?bf|\+?fee|\+?fees))/gi,
                ""
              )
              // bare price ranges like 10/12 (no currency)
              .replace(
                /\b\d{1,3}(?:\.\d{2})?\s*\/\s*\d{1,3}(?:\.\d{2})?\b/g,
                ""
              );

            // ---- Convert dotted times ONLY (e.g. "8.30" â†’ "8:30") ----
            s = s.replace(
              /\b(\d{1,2})\.(\d{2})(?:\s*\/\s*\d{1,2}(?::\d{2})?)?\b/g,
              "$1:$2"
            );

            // ---- Strip jelly words & trailing range ends ----
            s = s
              .replace(
                /\b(doors?|from|start(?:s)?|show(?:time)?|music)\b\s*[:\-â€“]?\s*/g,
                ""
              )
              .replace(/\b(?:till|â€™?\s*til|til)\s*late\b/g, "")
              .replace(/\blate\b/g, "")
              // remove trailing "â€“ 11pm" range ends so we keep the first time
              .replace(/\s*[â€“-]\s*\d{1,2}(?::\d{2})?\s*(?:am|pm)?\b/g, "")
              .trim();

            // 12h with minutes (e.g. "9:30 pm")
            let m = s.match(/\b(\d{1,2})(?::(\d{2}))\s*(am|pm)\b/i);
            if (m) {
              let hh = parseInt(m[1], 10);
              const mm = m[2] || "00";
              const ap = m[3].toLowerCase();
              if (ap === "pm" && hh !== 12) hh += 12;
              if (ap === "am" && hh === 12) hh = 0;
              return (
                String(hh).padStart(2, "0") + ":" + String(mm).padStart(2, "0")
              );
            }

            // 12h hour only (e.g. "9 pm")
            m = s.match(/\b(\d{1,2})\s*(am|pm)\b/i);
            if (m) {
              let hh = parseInt(m[1], 10);
              const ap = m[2].toLowerCase();
              if (ap === "pm" && hh !== 12) hh += 12;
              if (ap === "am" && hh === 12) hh = 0;
              return String(hh).padStart(2, "0") + ":00";
            }

            // 24h (e.g. "21:00" or from earlier "8.30" â†’ "8:30")
            m = s.match(/\b(\d{1,2}):(\d{2})\b/);
            if (m) {
              const hh = Math.min(23, Math.max(0, parseInt(m[1], 10)));
              const mm = Math.min(59, Math.max(0, parseInt(m[2], 10)));
              return (
                String(hh).padStart(2, "0") + ":" + String(mm).padStart(2, "0")
              );
            }

            // Bare hour heuristic (evening bias 5â€“11 â†’ PM)
            m = s.match(/(?:^|\b)(\d{1,2})(?:\b|$)/);
            if (m) {
              const hhNum = parseInt(m[1], 10);
              if (hhNum >= 5 && hhNum <= 11)
                return String(hhNum + 12).padStart(2, "0") + ":00";
              if (hhNum === 12) return "12:00";
            }

            return null;
          };

          const firstTimeSnippet = (raw) => {
            if (!raw) return null;
            const s = String(raw);
            let m = s.match(/\b\d{1,2}(?::\d{2})?\s*(?:am|pm)\b/i);
            if (m) return m[0];
            m = s.match(/\b\d{1,2}:\d{2}\b/);
            if (m) return m[0];
            m = s.match(
              /\bdoors?\s*[:\-]?\s*\d{1,2}(?::\d{2})?\s*(?:am|pm)?\b/i
            );
            if (m) return m[0];
            return null;
          };
          const pickTimeText = (ev) => {
            // Treat The People's Republic specially: only trust explicit time fields.
            const isTPR = /\bpeople'?s republic\b/i.test(
              String(ev.source || "") + " " + String(ev.venue || "")
            );

            // 1) Always try explicit, structured fields first
            const explicit = [
              ev.displayTime24,
              ev.timeText,
              ev.time,
              ev.time_text,
            ].filter(Boolean);
            for (const f of explicit) {
              const norm = to24h(f);
              if (norm) return { kind: "parsed", value: norm };
              const raw = firstTimeSnippet(f);
              if (raw) return { kind: "raw", value: raw };
            }

            // 2) For non-TPR only, allow softer fields (meta/notes/description/title)
            if (!isTPR) {
              const soft = [ev.meta, ev.notes, ev.description, ev.title].filter(
                Boolean
              );
              for (const f of soft) {
                const norm = to24h(f);
                if (norm) return { kind: "parsed", value: norm };
                const raw = firstTimeSnippet(f);
                if (raw) return { kind: "raw", value: raw };
              }
            }

            // 3) Nothing found
            return null;
          };

          // Extract closing time for NYE events (Dec 31)
          const getClosingTime = (ev) => {
            if (!ev.end) return null;
            const endDate = new Date(ev.end);
            if (isNaN(endDate)) return null;
            // Check if event is on Dec 31 or closing time is on Jan 1 (NYE)
            const startDate =
              ev._startEff || (ev.start ? new Date(ev.start) : null);
            if (!startDate || isNaN(startDate)) return null;
            if (startDate.getMonth() !== 11 || startDate.getDate() !== 31)
              return null;

            // Format closing time in 24h format
            const closingHour = endDate.getUTCHours();
            const closingMin = endDate.getUTCMinutes();
            return `${String(closingHour).padStart(2, "0")}:${String(
              closingMin
            ).padStart(2, "0")}`;
          };

          const q = els.q.value.trim();
          const sections = groupByDate(state.view, state.sort)
            .map(([key, items]) => {
              const label =
                key === "Undated"
                  ? "Undated"
                  : new Date(key + "T00:00:00").toLocaleDateString("en-GB", {
                      weekday: "short",
                      day: "2-digit",
                      month: "short",
                      year: "numeric",
                      timeZone: state.TZ,
                    });

              const grid = items
                .map((ev) => {
                  const titleRaw = ev.title || "Untitled";
                  const vLabel = venueLabel(ev);
                  const displayTitle = ensureVenueInTitle(titleRaw, vLabel);
                  const openHref = toListingsUrl(ev.url || "", ev.source);
                  const gHref = googleHref(ev);
                  const isIcs = isIcsLike(ev.url || "");
                  const eid = escapeHTML(ev._id || "");

                  let time24 = "";
                  const mined = pickTimeText(ev);

                  if (ev.displayTime24) {
                    time24 = ev.displayTime24;
                  } else if (mined && mined.kind === "parsed") {
                    time24 = mined.value;
                  } else if (mined && mined.kind === "raw") {
                    time24 = mined.value;
                  } else if (
                    ev._hasDate &&
                    ev._startEff instanceof Date &&
                    !isNaN(+ev._startEff)
                  ) {
                    time24 = ev._startEff.toLocaleTimeString("en-GB", {
                      hour: "2-digit",
                      minute: "2-digit",
                      hour12: false,
                      timeZone: state.TZ,
                    });
                  }
                  // Adelphi safeguard: if a morning-looking time slips through, default to 20:00
                  if (venueLabel(ev) === "The New Adelphi Club") {
                    const m = /^(\d{1,2}):(\d{2})$/.exec(time24 || "");
                    if (m) {
                      const hh = parseInt(m[1], 10);
                      if (hh >= 0 && hh <= 11) time24 = "20:00";
                    }
                  }

                  let timeHTML = "";
                  const dISO = ev._startEff ? toLocalISO(ev._startEff) : null;
                  if (time24) {
                    timeHTML = dISO
                      ? `<time datetime="${escapeHTML(dISO)}">${escapeHTML(
                          time24
                        )}</time>`
                      : escapeHTML(time24);
                  }

                  const meta = [timeHTML, ev.venue && highlight(ev.venue, q)]
                    .filter(Boolean)
                    .join(" Â· ");
                  const src = escapeHTML(vLabel || "Unknown");

                  const ticketObj = Array.isArray(ev.tickets)
                    ? ev.tickets.find((t) => t && (t.url || t.link))
                    : null;
                  const ticketUrl =
                    ticketObj?.url ||
                    ticketObj?.link ||
                    ev.ticketUrl ||
                    ev.ticketsUrl ||
                    ev.linkTickets ||
                    null;

                  let showOpen = isMeaningfulLink(openHref);
                  let showTicket = isMeaningfulLink(ticketUrl);

                  // if Commun'ull and the â€œticketâ€ link is just Facebook, don't show a Tickets button
                  const vName = venueLabel(ev);
                  if (
                    DEFAULT_FREE_VENUES.has(vName) &&
                    isFacebookUrl(ticketUrl)
                  ) {
                    showTicket = false;
                  }

                  // Determine event status for badge/button display
                  const sold = isSoldOut(ev);
                  const postponed = isPostponed(ev);
                  const noBookings = isNoBookingsEvent(ev);
                  const isFree = isFreeEvent(ev);

                  // Build action button based on event status priority: Sold > No Bookings > Postponed > Free > Tickets > Details TBC
                  let actions = "";
                  if (sold) {
                    actions += `<button class="btn sold" type="button" disabled aria-disabled="true">
    Sold out
  </button>`;
                  } else if (noBookings) {
                    actions += `<button class="btn nobook" type="button" disabled aria-disabled="true">
    No Bookings
  </button>`;
                  } else if (postponed) {
                    actions += `<button class="btn post" type="button" disabled aria-disabled="true">
    Postponed
  </button>`;
                  } else if (isFree) {
                    // For free events: show Free Entry button with link if tickets URL exists, otherwise disabled button
                    if (showTicket) {
                      actions += `<a class="btn free"
      data-kind="tickets"
      data-eid="${eid}"
      href="${escapeHTML(ticketUrl)}"
      target="_blank"
      rel="noopener noreferrer"
      title="Free Entry">
      Free Entry
    </a>`;
                    } else {
                      actions += `<button class="btn free" type="button" disabled aria-disabled="true">
    Free entry
  </button>`;
                    }
                  } else if (showTicket) {
                    // For paid events with ticket link: show blue Tickets button
                    // Extract price from ticket label if available
                    let priceDisplay = "";
                    if (Array.isArray(ev.tickets) && ev.tickets[0]?.label) {
                      const ticketLabel = ev.tickets[0].label;
                      // Extract price pattern like "Â£7.00", "Â£7.70 (Â£7.00)", etc.
                      const priceMatch = ticketLabel.match(
                        /Â£\d+(?:\.\d{2})?(?:\s*\([^)]*\))?/
                      );
                      if (priceMatch) {
                        priceDisplay = `<span class="price">${escapeHTML(
                          priceMatch[0]
                        )}</span>`;
                      }
                    }
                    // Fallback to other price fields if not found in tickets
                    if (!priceDisplay) {
                      const priceInfo =
                        ev.price || ev.priceText || ev.admission || ev.cost;
                      if (priceInfo) {
                        priceDisplay = `<span class="price">${escapeHTML(
                          String(priceInfo)
                        )}</span>`;
                      }
                    }
                    // Final fallback: look for price in description or meta
                    if (!priceDisplay && (ev.description || ev.meta)) {
                      const text = `${ev.description || ""} ${ev.meta || ""}`;
                      const priceMatch = text.match(
                        /Â£\d+(?:\.\d{2})?(?:\s*\/\s*Â£\d+(?:\.\d{2})?)?/
                      );
                      if (priceMatch) {
                        priceDisplay = `<span class="price">${escapeHTML(
                          priceMatch[0]
                        )}</span>`;
                      }
                    }
                    actions += `<a class="btn"
      data-kind="tickets"
      data-eid="${eid}"
      href="${escapeHTML(ticketUrl)}"
      target="_blank"
      rel="noopener noreferrer">Tickets${priceDisplay}</a>`;
                  } else {
                    // Fallback for events with no status/ticket info: show Details TBC button
                    actions += `<button class="btn" type="button" disabled aria-disabled="true" style="color: var(--muted); border-color: var(--muted); background: transparent;">
    Details TBC
  </button>`;
                  }

                  const d = ev._startEff || null;
                  const dparts = d
                    ? {
                        dow: d.toLocaleDateString("en-GB", {
                          weekday: "short",
                        }),
                        day: String(d.getDate()).padStart(2, "0"),
                        mon: d.toLocaleDateString("en-GB", { month: "short" }),
                      }
                    : { dow: "", day: "â€“", mon: "" };

                  return `
          <article class="event" role="article" aria-label="${escapeHTML(
            titleRaw
          )}">
            <div class="pill" aria-hidden="true">
              <div class="dow">${dparts.dow}</div>
              <div class="day">${dparts.day}</div>
              <div class="mon">${dparts.mon}</div>
            </div>
            <div class="event-content">
<h2 class="title"><a href="${escapeHTML(
                    openHref
                  )}" target="_blank" rel="noopener noreferrer">${highlight(
                    displayTitle,
                    q
                  )}</a></h2>
              <div class="meta">${
                meta || "<span class='muty'>Details TBC</span>"
              }</div>
              <div class="source">
                <span>ðŸ“</span>
                <span>${
                  ev.address
                    ? escapeHTML(ev.address)
                    : ev.venue
                    ? escapeHTML(ev.venue)
                    : ""
                }</span>
              </div>
            </div>
<div class="card-actions">
  ${actions}

  ${
    gHref
      ? `<a class="btn"
            data-kind="google"
            data-eid="${eid}"
            href="${escapeHTML(gHref)}"
            target="_blank"
            rel="noopener noreferrer"
        >Add to Google</a>`
      : ""
  }

  ${
    showOpen
      ? `<a class="btn"
            data-kind="open"
            data-eid="${eid}"
            href="${escapeHTML(openHref)}"
            target="_blank"
            rel="noopener noreferrer"
        >${isIcs ? "Open listings" : "Open"}</a>`
      : ""
  }
</div>
          </article>`;
                })
                .join("");

              return `<section class="section" id="${escapeHTML(
                key === "Undated" ? "undated" : key
              )}"><h3>${label}</h3>${
                // Check if this is NYE (Dec 31) and add closing times card
                key === "2025-12-31"
                  ? `<div class="grid">
                      <article class="event" style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(255, 170, 0, 0.05) 100%); border: 2px solid var(--accent); position: relative; margin-bottom: 16px;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 20% 50%, rgba(0, 240, 255, 0.05) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(255, 170, 0, 0.05) 0%, transparent 50%); pointer-events: none;"></div>
                        <div style="padding: 24px; position: relative; z-index: 1;">
                          <div style="text-align: center; margin-bottom: 20px;">
                            <h2 class="title" style="color: var(--accent); margin: 0 0 4px 0; font-size: 18px; letter-spacing: 0.5px;">ðŸ¾ HU5 NYE Closing Times</h2>
                            <div style="height: 2px; background: linear-gradient(90deg, transparent, var(--accent), transparent); margin-top: 8px;"></div>
                          </div>
                          <div class="nye-grid">
                            <div style="padding: 12px; border-radius: 8px; background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(0, 212, 255, 0.05) 100%); border: 1.5px solid rgba(0, 212, 255, 0.4); text-align: center; transition: all 0.3s; cursor: default;">
                              <div style="font-size: 11px; font-weight: 700; color: var(--text); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px;">Molly Mangan's</div>
                              <div style="font-size: 16px; font-weight: 800; color: var(--accent); text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);">3am</div>
                            </div>
                            <div style="padding: 12px; border-radius: 8px; background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(0, 212, 255, 0.05) 100%); border: 1.5px solid rgba(0, 212, 255, 0.4); text-align: center; transition: all 0.3s; cursor: default;">
                              <div style="font-size: 11px; font-weight: 700; color: var(--text); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px;">Polar Bear</div>
                              <div style="font-size: 16px; font-weight: 800; color: var(--accent); text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);">2:30am</div>
                            </div>
                            <div style="padding: 12px; border-radius: 8px; background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(0, 212, 255, 0.05) 100%); border: 1.5px solid rgba(0, 212, 255, 0.4); text-align: center; transition: all 0.3s; cursor: default;">
                              <div style="font-size: 11px; font-weight: 700; color: var(--text); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px;">The Welly</div>
                              <div style="font-size: 16px; font-weight: 800; color: var(--accent); text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);">3am</div>
                            </div>
                            <div style="padding: 12px; border-radius: 8px; background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(0, 212, 255, 0.05) 100%); border: 1.5px solid rgba(0, 212, 255, 0.4); text-align: center; transition: all 0.3s; cursor: default;">
                              <div style="font-size: 11px; font-weight: 700; color: var(--text); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px;">TPR</div>
                              <div style="font-size: 16px; font-weight: 800; color: var(--accent); text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);">1am</div>
                            </div>
                            <div style="padding: 12px; border-radius: 8px; background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(0, 212, 255, 0.05) 100%); border: 1.5px solid rgba(0, 212, 255, 0.4); text-align: center; transition: all 0.3s; cursor: default;">
                              <div style="font-size: 11px; font-weight: 700; color: var(--text); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px;">Queens Hotel</div>
                              <div style="font-size: 16px; font-weight: 800; color: var(--accent); text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);">1am</div>
                            </div>
                            <div style="padding: 12px; border-radius: 8px; background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(0, 212, 255, 0.05) 100%); border: 1.5px solid rgba(0, 212, 255, 0.4); text-align: center; transition: all 0.3s; cursor: default;">
                              <div style="font-size: 11px; font-weight: 700; color: var(--text); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px;">SpÃ¤ti</div>
                              <div style="font-size: 16px; font-weight: 800; color: var(--accent); text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);">2am</div>
                            </div>
                            <div style="padding: 12px; border-radius: 8px; background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(0, 212, 255, 0.05) 100%); border: 1.5px solid rgba(0, 212, 255, 0.4); text-align: center; transition: all 0.3s; cursor: default;">
                              <div style="font-size: 11px; font-weight: 700; color: var(--text); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px;">Hoi</div>
                              <div style="font-size: 16px; font-weight: 800; color: var(--accent); text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);">1am</div>
                            </div>
                            <div style="padding: 12px; border-radius: 8px; background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(0, 212, 255, 0.05) 100%); border: 1.5px solid rgba(0, 212, 255, 0.4); text-align: center; transition: all 0.3s; cursor: default;">
                              <div style="font-size: 11px; font-weight: 700; color: var(--text); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px;">St John's</div>
                              <div style="font-size: 16px; font-weight: 800; color: var(--accent); text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);">2am</div>
                            </div>
                            <div style="padding: 12px; border-radius: 8px; background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(0, 212, 255, 0.05) 100%); border: 1.5px solid rgba(0, 212, 255, 0.4); text-align: center; transition: all 0.3s; cursor: default;">
                              <div style="font-size: 11px; font-weight: 700; color: var(--text); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px;">Dive</div>
                              <div style="font-size: 16px; font-weight: 800; color: var(--accent); text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);">1:30am</div>
                            </div>
                            <div style="padding: 12px; border-radius: 8px; background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(0, 212, 255, 0.05) 100%); border: 1.5px solid rgba(0, 212, 255, 0.4); text-align: center; transition: all 0.3s; cursor: default;">
                              <div style="font-size: 11px; font-weight: 700; color: var(--text); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px;">Mr Moody's</div>
                              <div style="font-size: 16px; font-weight: 800; color: var(--accent); text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);">1am</div>
                            </div>
                          </div>
                          <div style="text-align: center; margin-top: 14px; padding-top: 12px; border-top: 1px solid rgba(0, 212, 255, 0.2); font-size: 12px; color: var(--muted);">
                            <span style="color: var(--accent);">*</span> If times and events are incorrect, please <a href="mailto:hu5eventsfinder@gmail.com" style="color: var(--accent); text-decoration: none; font-weight: 600;">email us</a>
                          </div>
                        </div>
                      </article>
                    </div>`
                  : ""
              }<div class="grid">${grid}</div></section>`;
            })
            .join("");

          els.list.innerHTML = sections;

          if (!document.__hu5Delegated) {
            document.__hu5Delegated = true;

            document.addEventListener("click", (e) => {
              const a = e.target.closest("[data-kind]");
              if (!a) return;

              const kind = a.getAttribute("data-kind");
              const eid = a.getAttribute("data-eid");
              const ev =
                state.view.find((x) => x._id === eid) ||
                state.all.find((x) => x._id === eid);

              if (kind === "ics") {
                e.preventDefault();
                if (!ev) return;
                const blob = buildICS(ev);
                if (!blob) return;
                const url = URL.createObjectURL(blob);
                const name =
                  (ev.title ? ev.title.replace(/[^\w\-]+/g, "_") : "event") +
                  ".ics";
                const tmp = document.createElement("a");
                tmp.href = url;
                tmp.download = name;
                document.body.appendChild(tmp);
                tmp.click();
                document.body.removeChild(tmp);
                URL.revokeObjectURL(url);
                track("download_ics", {
                  venue: venueLabel(ev),
                  title: ev.title || "(untitled)",
                });
                showToast("Added to calendar");
                return;
              }

              // Track outbound clicks
              if (kind === "tickets" || kind === "open" || kind === "google") {
                if (ev)
                  track(kind + "_click", {
                    venue: venueLabel(ev),
                    title: ev.title || "(untitled)",
                    date: ev._startEff ? ev._startEff.toISOString() : undefined,
                  });
              }
            });
          }

          const dated = state.all.filter((e) => e._hasDate).length;
          const undated = state.all.length - dated;
          state.stats.totalEvents = state.all.length;
          state.stats.datedEvents = dated;
          state.stats.undatedEvents = undated;
          state.stats.lastRenderMs = Math.round(performance.now() - t0);
          state.stats.venues = state.all.reduce((acc, e) => {
            const v = venueLabel(e);
            acc[v] = (acc[v] || 0) + 1;
            return acc;
          }, {});
          if (state.isAdmin) updateAdminPanel();

          replaceUrl();
          updateMailto();
        }

        /* ============================== FILTERS ============================= */
        function setDateRange(from, to) {
          const fmt = (d) => {
            const p = (n) => String(n).padStart(2, "0");
            return `${d.getFullYear()}-${p(d.getMonth() + 1)}-${p(
              d.getDate()
            )}`;
          };
          els.from.value = fmt(from);
          els.to.value = fmt(to);
          save();
          apply();
          const visibleAnchor =
            document.elementFromPoint(0, 140)?.closest("section")?.id || null;
        }
        function applyQuickRange(kind) {
          state.range = kind;
          syncRangeButtons();
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          if (kind === "today") {
            const t = new Date(today);
            setDateRange(t, t);
            return;
          }
          if (kind === "next7") {
            const to = new Date(today);
            to.setDate(to.getDate() + 6);
            setDateRange(today, to);
            return;
          }
          if (kind === "weekend") {
            const dow = today.getDay();
            let from, to;
            if (dow === 6) {
              from = new Date(today);
              to = new Date(today);
              to.setDate(to.getDate() + 1);
            } else if (dow === 0) {
              from = new Date(today);
              to = new Date(today);
            } else {
              const sat = new Date(today);
              sat.setDate(sat.getDate() + (6 - dow));
              const sun = new Date(sat);
              sun.setDate(sun.getDate() + 1);
              from = sat;
              to = sun;
            }
            setDateRange(from, to);
            return;
          }
          els.from.value = "";
          els.to.value = "";
          save();
          apply();
        }
        function syncRangeButtons() {
          els.rangeButtons.forEach((b) => {
            const active = b.dataset.range === state.range;
            b.setAttribute("aria-pressed", active ? "true" : "false");
            b.classList.toggle("is-active", active);
          });
        }

        function apply() {
          const q = els.q.value.toLowerCase().trim();
          const hasFrom = !!els.from.value,
            hasTo = !!els.to.value;
          const from = hasFrom ? +new Date(els.from.value) : null;
          const to = hasTo ? +new Date(els.to.value + "T23:59:59") : null;
          state.sort = els.sort.value;
          const vfilter = els.venue.value;

          let arr = [...state.all];

          // Keep dated events from today (local) onwards; keep undated (weâ€™ll hide if toggle off)
          const today0 = startOfTodayLocal();
          arr = arr.filter((e) => {
            if (!e._hasDate) return true;
            return +e._startEff >= +today0;
          });

          // text query
          if (q) {
            arr = arr.filter((e) =>
              `${e.title || ""} ${e.venue || ""} ${e.address || ""} ${
                e.source || ""
              }`
                .toLowerCase()
                .includes(q)
            );
          }

          // range window: only if user sets a from/to
          if (hasFrom || hasTo) {
            arr = arr.filter((e) => e._hasDate);
            if (hasFrom) arr = arr.filter((e) => +e._startEff >= from);
            if (hasTo) arr = arr.filter((e) => +e._startEff <= to);
          } else {
            if (!state.showUndated) arr = arr.filter((e) => e._hasDate);
          }

          if (vfilter) arr = arr.filter((e) => venueLabel(e) === vfilter);

          // sort by effective date or title
          if (state.sort === "date-asc")
            arr.sort((a, b) => (+a._startEff || 9e15) - (+b._startEff || 9e15));
          else if (state.sort === "date-desc")
            arr.sort(
              (a, b) => (+b._startEff || -9e15) - (+a._startEff || -9e15)
            );
          else if (state.sort === "title")
            arr.sort((a, b) => (a.title || "").localeCompare(b.title || ""));

          state.view = arr;
          render();
          save();
          state.stats.filtersUsed += 1;
          state.stats.lastAppliedAt = new Date().toISOString();
        }

        function resetFilters() {
          els.q.value = "";
          els.from.value = "";
          els.to.value = "";
          els.sort.value = "date-asc";
          els.venue.value = "";
          state.range = "all";
          state.showUndated = true;
          syncRangeButtons();
          els.toggleUndated.setAttribute("aria-pressed", "true");
          els.toggleUndated.textContent = "Hide undated";
        }

        /* ============================= STORAGE ============================== */
        function save() {
          const data = {
            q: els.q.value || "",
            from: els.from.value || "",
            to: els.to.value || "",
            sort: els.sort.value || "date-asc",
            venue: els.venue.value || "",
            range: state.range,
            showUndated: state.showUndated,
          };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }
        function load() {
          const saved = localStorage.getItem(STORAGE_KEY);
          let data = saved ? JSON.parse(saved) : {};
          paramsToFilters(location.href);
          els.q.value = els.q.value || data.q || "";
          els.from.value = els.from.value || data.from || "";
          els.to.value = els.to.value || data.to || "";
          els.sort.value = els.sort.value || data.sort || "date-asc";
          els.venue.value = els.venue.value || data.venue || "";
          state.range = state.range || data.range || "all";
          if (typeof state.showUndated !== "boolean")
            state.showUndated =
              typeof data.showUndated === "boolean" ? data.showUndated : true;
          syncRangeButtons();
          els.toggleUndated.setAttribute(
            "aria-pressed",
            state.showUndated ? "true" : "false"
          );
          els.toggleUndated.textContent = state.showUndated
            ? "Hide undated"
            : "Show undated";
        }

        /* ============================== ADMIN ============================== */
        function updateAdminPanel() {
          const s = state.stats;
          $(
            "#adminSummary"
          ).textContent = `Loads: ${s.loads} â€¢ Last load: ${s.lastLoadMs}ms â€¢ Render: ${s.lastRenderMs}ms â€¢ Filters used: ${s.filtersUsed}`;
          const venueRows = Object.entries(s.venues)
            .sort((a, b) => b[1] - a[1])
            .map(([v, c]) => `<tr><td>${escapeHTML(v)}</td><td>${c}</td></tr>`)
            .join("");
          $("#adminTable").innerHTML = `
      <tr><th>Total events</th><td>${s.totalEvents}</td></tr>
      <tr><th>Dated</th><td>${s.datedEvents}</td></tr>
      <tr><th>Undated</th><td>${s.undatedEvents}</td></tr>
      <tr><th>Last updated</th><td>${
        state.lastUpdated ? state.lastUpdated.toLocaleString() : "â€”"
      }</td></tr>
      <tr><th>Last filters applied</th><td>${s.lastAppliedAt || "â€”"}</td></tr>
      <tr><th colspan="2"><strong>Events per venue</strong></th></tr>
      ${venueRows || '<tr><td colspan="2" class="muty">No data</td></tr>'}
    `;
        }
        const setAdmin = (on) => {
          state.isAdmin = !!on;
          localStorage.setItem(ADMIN_KEY, state.isAdmin ? "1" : "");
          els.admin.hidden = !state.isAdmin;
          if (state.isAdmin) updateAdminPanel();
        };

        /* ============================== UI BITS ============================= */
        function showToast(msg = "Link copied") {
          if (!els.toast) return;
          els.toast.textContent = msg;
          els.toast.classList.add("show");
          clearTimeout(showToast._t);
          showToast._t = setTimeout(
            () => els.toast.classList.remove("show"),
            1400
          );
        }

        // bindings
        const debounce = (fn, ms) => {
          let t;
          return (...a) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...a), ms);
          };
        };
        const onFilterInput = debounce(() => apply(), 150);
        ["input", "change"].forEach(function (evt) {
          [els.q, els.from, els.to, els.sort, els.venue].forEach(function (el) {
            if (el) el.addEventListener(evt, onFilterInput);
          });
        });

        var resetBtn = $("#resetBtn");
        if (resetBtn)
          resetBtn.addEventListener("click", function () {
            resetFilters();
            apply();
          });

        els.auto?.addEventListener("change", () => {
          state.autoRefresh = !!els.auto.checked;
          if (state.autoRefresh) {
            scheduleTick();
            tickUI();
          } else {
            clearTimeout(scheduleTick._t);
            state.nextTickAt = null;
            $("#refreshText").textContent = "Auto refresh off";
          }
          render();
          save();
        });

        els.rangeButtons.forEach((btn) =>
          btn.addEventListener("click", () =>
            applyQuickRange(btn.dataset.range)
          )
        );
        els.toggleUndated?.addEventListener("click", () => {
          state.showUndated = !state.showUndated;
          els.toggleUndated.setAttribute(
            "aria-pressed",
            state.showUndated ? "true" : "false"
          );
          els.toggleUndated.textContent = state.showUndated
            ? "Hide undated"
            : "Show undated";
          apply();
        });
        els.refreshNow?.addEventListener("click", async () => {
          await boot(false);
          showToast("Refreshed");
        });
        els.clear?.addEventListener("click", () => {
          localStorage.removeItem(STORAGE_KEY);
          resetFilters();
          apply();
        });

        els.share?.addEventListener("click", async () => {
          replaceUrl();
          updateMailto();
          const url = location.href;
          const title = "HU5 Events Finder";
          if (navigator.share) {
            try {
              await navigator.share({ title, url });
              return;
            } catch {}
          }
          try {
            await navigator.clipboard.writeText(url);
            showToast("Link copied");
          } catch {
            prompt("Copy this link", url);
          }
        });

        els.copyStats?.addEventListener("click", async () => {
          const payload = {
            stats: state.stats,
            lastUpdated: state.lastUpdated?.toISOString() || null,
          };
          const json = JSON.stringify(payload, null, 2);

          try {
            await navigator.clipboard.writeText(json);
            showToast("Stats copied");
          } catch {
            // Fallback if clipboard fails
            prompt("Copy stats JSON:", json);
          }
        });

        els.closeAdmin?.addEventListener("click", () => {
          setAdmin(false);
        });

        window.addEventListener("keydown", (e) => {
          const tag = (e.target && (e.target.tagName || "")).toLowerCase();
          const isTyping =
            tag === "input" || tag === "textarea" || e.isComposing;
          if (e.key === "/" && !isTyping) {
            e.preventDefault();
            els.q.focus();
            els.q.select();
          }
          if (e.key.toLowerCase() === "r" && !isTyping) {
            e.preventDefault();
            els.refreshNow.click();
          }
          if (e.key.toLowerCase() === "c" && !isTyping) {
            e.preventDefault();
            els.share.click();
          }
          const mod = e.ctrlKey || e.metaKey;
          if (mod && e.shiftKey && (e.key === "S" || e.key === "s")) {
            e.preventDefault();
            setAdmin(!state.isAdmin);
          }
        });

        // mobile back-to-top
        els.fabTop?.addEventListener("click", () =>
          window.scrollTo({ top: 0, behavior: "smooth" })
        );

        // collapsible filters (compensate scroll jump)
        els.filtersToggle?.addEventListener("click", () => {
          const header = document.querySelector("header");
          const before = header.getBoundingClientRect().height;
          const willOpen = els.filtersPanel.classList.contains("hidden");
          els.filtersPanel.classList.toggle("hidden");
          els.filtersToggle.setAttribute(
            "aria-expanded",
            willOpen ? "true" : "false"
          );
          requestAnimationFrame(() => {
            const after = header.getBoundingClientRect().height;
            const diff = after - before;
            if (diff) window.scrollBy(0, diff);
          });
        });

        // auto-refresh timer chip
        // auto-refresh timer chip
        function scheduleTick() {
          // Always clear any pending timeout first
          clearTimeout(scheduleTick._t);

          if (!state.autoRefresh) {
            state.nextTickAt = null;
            // Stop the rAF loop and set UI text/state
            tickUIStop();
            const dot = document.querySelector("#nextRefresh .dot");
            if (dot) dot.className = "dot warn";
            els.refreshText.textContent = "Auto refresh off";
            return;
          }

          // Plan next refresh and start/keep the UI countdown
          state.nextTickAt = Date.now() + state.refreshMs;
          scheduleTick._t = setTimeout(async () => {
            await boot(false); // reload data
            scheduleTick(); // schedule the next tick
          }, state.refreshMs);

          // Ensure we have exactly one rAF loop running
          if (!tickUI._raf) tickUI();
        }

        function tickUI() {
          // If disabled or no next tick, stop the loop and set UI appropriately
          if (!state.autoRefresh || !state.nextTickAt) {
            tickUIStop();
            const dot = document.querySelector("#nextRefresh .dot");
            if (dot)
              dot.className = "dot " + (state.autoRefresh ? "good" : "warn");
            els.refreshText.textContent = state.autoRefresh
              ? "Auto refresh on"
              : "Auto refresh off";
            return;
          }

          const dot = document.querySelector("#nextRefresh .dot");
          const ms = Math.max(0, state.nextTickAt - Date.now());
          if (ms === 0) {
            els.refreshText.textContent = "Refreshingâ€¦";
          }
          const m = Math.floor(ms / 60000);
          const s = Math.floor((ms % 60000) / 1000);

          if (dot) dot.className = "dot good";
          els.refreshText.textContent = `Auto refresh in ${m}:${String(
            s
          ).padStart(2, "0")}`;

          tickUI._raf = requestAnimationFrame(tickUI);
        }

        function tickUIStop() {
          if (tickUI._raf) {
            cancelAnimationFrame(tickUI._raf);
            tickUI._raf = null;
          }
        }

        function reasonHidden(ev, today0) {
          if (!ev) return "no event";
          if (!ev._hasDate) return "undated (_startEff missing)";
          if (+ev._startEff < +today0) return "past date";
          return "";
        }

        function dumpAdelphiDiagnostics(where = "console") {
          const today0 = startOfTodayLocal();
          const rows = state.all
            .filter((e) =>
              /\badelphi\b/i.test(
                String(e.source || "") + " " + String(e.venue || "")
              )
            )
            .map((e) => ({
              title: e.title || "(no title)",
              url: e.url || "",
              source: e.source || "",
              venue: e.venue || "",
              dateText: e.dateText || "",
              timeText: e.timeText || "",
              start: e.start || "",
              startISO: e.startISO || e.start_iso || "",
              displayTime24: e.displayTime24 || "",
              displayDateTime24: e.displayDateTime24 || e.displayDateTime || "",
              _hasDate: !!e._hasDate,
              _startEff: e._startEff
                ? e._startEff.toISOString
                  ? e._startEff.toISOString()
                  : String(e._startEff)
                : "",
              hiddenReason: reasonHidden(e, today0),
            }));

          if (where === "console") {
            console.group("[HU5] Adelphi diagnostics");
            console.table(rows);
            console.groupEnd();
          } else {
            const pre = document.createElement("pre");
            pre.style.whiteSpace = "pre-wrap";
            pre.style.font =
              "12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
            pre.style.padding = "12px";
            pre.style.border = "1px solid var(--border)";
            pre.style.borderRadius = "12px";
            pre.style.background = "var(--card)";
            pre.textContent = JSON.stringify(rows, null, 2);
            const host = document.createElement("div");
            host.className = "section";
            host.innerHTML = "<h3>Adelphi diagnostics</h3>";
            host.appendChild(pre);
            document.querySelector("main.wrap")?.prepend(host);
          }
        }
        /* =============================== BOOT =============================== */
        async function boot(initial = false) {
          try {
            els.status.hidden = false;
            els.status.className = "empty";
            els.status.textContent = initial ? "Loadingâ€¦" : "Refreshingâ€¦";
            load();
            const data = await fetchEventsJson();

            // IMPORTANT: compute effective start BEFORE apply()
            state.all = (Array.isArray(data) ? data : []).map((ev, idx) => {
              // (existing title sanitise)
              try {
                const div = document.createElement("div");
                div.innerHTML = ev.title || "";
                ev.title = div.textContent || div.innerText || ev.title || "";
              } catch {}

              // (existing effective start calc)
              let eff = computeEffectiveStart(ev);

              // (existing TPR no-year logic)
              const isTPR = /\bpeople'?s republic\b/i.test(
                String(ev.source || "") + " " + String(ev.venue || "")
              );
              if (isTPR) {
                const yearProbe = [
                  ev.start,
                  ev.startISO,
                  ev.start_iso,
                  ev.startDate,
                  ev.start_date,
                  ev.dateText,
                  ev.dateOnly,
                  ev.displayDateTime24,
                  ev.displayDateTime,
                ]
                  .filter(Boolean)
                  .join(" ");
                const hasYear = /\b\d{4}\b/.test(yearProbe);
                if (!hasYear) {
                  eff = null;
                  delete ev.displayDateTime24;
                  delete ev.displayDateTime;
                  if (!ev.displayTime24 && !ev.timeText && !ev.time)
                    ev.displayTime24 = "20:00";
                }
              }

              if (Array.isArray(ev.badges)) {
                ev.badges = ev.badges.filter(
                  (b) => !/^(postponed)$/i.test(String(b || ""))
                );
              }

              if (!ev._id) {
                ev._id = ev.id || ev.slug || String(idx);
              }

              return { ...ev, _startEff: eff, _hasDate: !!eff };
            });

            const byVenueUI = state.all.reduce((m, e) => {
              const v = (e.venue || e.source || "Unknown").trim();
              m[v] = (m[v] || 0) + 1;
              return m;
            }, {});
            console.log("[ui] counts by venue:", byVenueUI);

            if (state.isAdmin) {
              dumpAdelphiDiagnostics("console");
            }

            populateVenueFilter();
            apply();
            els.status.hidden = true;
            updateMailto();
            injectLD();
          } catch (e) {
            console.error(e);
            els.status.hidden = false;
            els.status.className = "error";
            els.status.textContent =
              e.message ||
              "Could not load events.json â€” run the fetcher first.";
          }
        }

        function populateVenueFilter() {
          const venues = Array.from(new Set(state.all.map(venueLabel))).sort();
          const counts = state.all.reduce((m, e) => {
            const v = venueLabel(e);
            m[v] = (m[v] || 0) + 1;
            return m;
          }, {});
          $("#venue").innerHTML = ['<option value="">All venues</option>']
            .concat(
              venues.map(
                (v) =>
                  `<option value="${escapeHTML(v)}">${escapeHTML(v)} (${
                    counts[v] || 0
                  })</option>`
              )
            )
            .join("");
        }

        (async () => {
          const u = new URL(location.href);
          if (u.searchParams.get("admin") === "1") setAdmin(true);
          setAdmin(localStorage.getItem(ADMIN_KEY) === "1");
          await boot(true);
          scheduleTick();
          tickUI();
        })();
      })();
    </script>
  </body>
</html>
